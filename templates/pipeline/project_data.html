{% extends 'base.html' %}
{% load pipeline_tags %}

{% block title %}{{ project.name }} - ë¡±í¼ ì˜ìƒ ì œì‘{% endblock %}

{% block extra_css %}
<style>
.step-section {
    border-left: 4px solid #dee2e6;
    margin-bottom: 1.5rem;
    background: #fff;
}
.step-section.has-data {
    border-left-color: #198754;
}
.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    cursor: pointer;
}
.step-header:hover {
    background: #e9ecef;
}
.step-body {
    padding: 1rem;
}
.char-counter {
    font-weight: bold;
}
.char-counter.good { color: #198754; }
.char-counter.warning { color: #ffc107; }
.char-counter.danger { color: #dc3545; }

/* Markdown ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
.markdown-content {
    font-size: 0.9rem;
    line-height: 1.6;
}
.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.85rem;
}
.markdown-content th, .markdown-content td {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    text-align: left;
}
.markdown-content th {
    background: #f8f9fa;
    font-weight: 600;
}
.markdown-content h2, .markdown-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}
.markdown-content h2 { font-size: 1.25rem; }
.markdown-content h3 { font-size: 1.1rem; }
.markdown-content ul, .markdown-content ol {
    padding-left: 1.5rem;
}
.markdown-content li {
    margin-bottom: 0.25rem;
}
.markdown-content strong {
    font-weight: 600;
}

/* ì”¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.scene-list {
    max-height: 70vh;
    overflow-y: auto;
}
.scene-card {
    display: grid;
    grid-template-columns: 50px 1fr 1fr 120px 120px 80px 100px;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    align-items: start;
}
.subtitle-status {
    font-size: 0.75em;
    text-align: center;
}
.subtitle-status.matched {
    color: #198754;
}
.subtitle-status.mismatch {
    color: #dc3545;
    font-weight: bold;
}
.subtitle-status.none {
    color: #6c757d;
}
.scene-audio {
    display: flex;
    align-items: center;
    gap: 4px;
}
.scene-audio audio {
    height: 30px;
    width: 100%;
}
.audio-loading {
    color: #6c757d;
    font-size: 0.8em;
}
.scene-card:hover {
    background: #f8f9fa;
}
.scene-number {
    font-size: 1.1em;
    color: #666;
}
.scene-narration {
    font-size: 0.95em;
    line-height: 1.5;
}
.narration-text {
    max-height: 80px;
    overflow: hidden;
}
.scene-prompt {
    font-size: 0.85em;
    color: #555;
    line-height: 1.4;
}
.prompt-text {
    max-height: 80px;
    overflow: hidden;
}
.prompt-empty {
    font-style: italic;
}
.scene-image {
    width: 120px;
    height: 68px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.scene-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
}
.image-placeholder {
    font-size: 1.5em;
}
/* ì˜ìƒ ì˜¤ë²„ë ˆì´ */
.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}
.video-overlay:hover {
    background: rgba(0,0,0,0.6);
}
.video-overlay i {
    color: white;
    font-size: 1.8em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
.scene-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.scene-actions .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
}

/* ì¸ë¼ì¸ í¸ì§‘ ìŠ¤íƒ€ì¼ */
.editable-text {
    cursor: text;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}
.editable-text:hover {
    background: #f0f0f0;
}
.editable-text:focus {
    background: #fff;
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}
.editable-text.saving {
    background: #fff3cd;
}
.editable-text.saved {
    background: #d1e7dd;
}
.editable-text.error {
    background: #f8d7da;
}
.editable-text:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
}

/* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
#imagePreviewModal .modal-body img {
    max-width: 100%;
    max-height: 80vh;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>{{ project.name }}</h2>
        <small class="text-muted">ìƒì„±: {{ project.created_at|date:"Y-m-d H:i" }}</small>
    </div>
    <div>
        <a href="{% url 'pipeline:project_settings' project.pk %}" class="btn btn-outline-info btn-sm">
            <i class="bi bi-gear"></i> ì„¤ì •
        </a>
        <a href="{% url 'pipeline:dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> ëª©ë¡
        </a>
        <form method="post" action="{% url 'pipeline:project_delete' project.pk %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

<!-- ì‘ì—… ëª©ë¡ (ì§„í–‰ ì¤‘ + ì‹¤íŒ¨ + ì™„ë£Œ) -->
{% if running_executions %}
<div class="card mb-4 border-primary" id="work-list-card">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-list-task"></i> ì‘ì—… ëª©ë¡
    </div>
    <ul class="list-group list-group-flush" id="work-list">
        {% for exec in running_executions %}
        <li class="list-group-item work-item {% if exec.status == 'failed' %}list-group-item-danger{% elif exec.status == 'completed' %}list-group-item-success{% endif %}"
            data-exec-id="{{ exec.pk }}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge {% if exec.status == 'running' %}bg-info{% elif exec.status == 'completed' %}bg-success{% else %}bg-danger{% endif %}">
                        {{ exec.step.display_name }}
                    </span>
                    {% if exec.status == 'failed' %}
                    <span class="badge bg-danger ms-1">ì‹¤íŒ¨</span>
                    {% elif exec.status == 'completed' %}
                    <span class="badge bg-success ms-1">ì™„ë£Œ</span>
                    {% endif %}
                    <small class="text-muted ms-2">{{ exec.created_at|date:"H:i" }}</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if exec.status == 'completed' %}
                    <a href="{% url 'pipeline:project_detail' project.pk %}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-folder"></i> ë³´ê¸°
                    </a>
                    {% else %}
                    <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> ë¡œê·¸
                    </a>
                    {% endif %}
                    {% if exec.status == 'running' %}
                    <button type="button" class="btn btn-sm btn-outline-danger btn-cancel-exec"
                            data-project-id="{{ project.pk }}" data-exec-id="{{ exec.pk }}">
                        <i class="bi bi-x-lg"></i> ì·¨ì†Œ
                    </button>
                    {% elif exec.status == 'completed' %}
                    <button type="button" class="btn btn-sm btn-success btn-dismiss-exec"
                            data-project-id="{{ project.pk }}" data-exec-id="{{ exec.pk }}">
                        <i class="bi bi-check-lg"></i> í™•ì¸
                    </button>
                    {% else %}
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk exec.step.name %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-arrow-clockwise"></i> ë‹¤ì‹œ
                        </button>
                    </form>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-delete-exec"
                            data-project-id="{{ project.pk }}" data-exec-id="{{ exec.pk }}">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% if exec.status == 'running' %}
            <div class="progress mt-2" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated exec-progress-bar"
                     data-exec-id="{{ exec.pk }}"
                     style="width: {{ exec.progress_percent }}%"></div>
            </div>
            <small class="text-muted exec-progress-text" data-exec-id="{{ exec.pk }}">{{ exec.progress_percent }}% - {{ exec.progress_message }}</small>
            {% elif exec.status == 'completed' %}
            <small class="text-success"><i class="bi bi-check-circle"></i> {{ exec.step.display_name }}ì´(ê°€) ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</small>
            {% else %}
            <small class="text-danger">{{ exec.error_message|truncatechars:80 }}</small>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>

<!-- ì‘ì—… ëª©ë¡ ìë™ ê°±ì‹  -->
<script>
(function() {
    const runningExecs = [{% for exec in running_executions %}{% if exec.status == 'running' %}{ id: {{ exec.pk }}, projectId: {{ project.pk }} },{% endif %}{% endfor %}];

    if (runningExecs.length === 0) return;

    function updateProgress() {
        runningExecs.forEach(exec => {
            fetch(`/pipeline/project/${exec.projectId}/progress/${exec.id}/api/`)
                .then(r => r.json())
                .then(data => {
                    const bar = document.querySelector(`.exec-progress-bar[data-exec-id="${exec.id}"]`);
                    const text = document.querySelector(`.exec-progress-text[data-exec-id="${exec.id}"]`);

                    if (bar) bar.style.width = data.progress_percent + '%';
                    if (text) text.textContent = `${data.progress_percent}% - ${data.progress_message}`;

                    // ì™„ë£Œ/ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    if (data.status !== 'running') {
                        setTimeout(() => location.reload(), 500);
                    }
                })
                .catch(err => console.log('Progress update error:', err));
        });
    }

    // 3ì´ˆë§ˆë‹¤ ê°±ì‹ 
    setInterval(updateProgress, 3000);
})();
</script>
{% endif %}

<!-- 1. ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œ -->
{% with exec=step_executions|dict_get:'topic_finder' %}
<div class="step-section {% if topic %}has-data{% endif %}" id="topic">
    <div class="step-header">
        <div>
            <strong>1. ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œ</strong>
            {% if topic %}
            <span class="ms-2">{{ topic.title|truncatechars:50 }}</span>
            {% if topic.video_id %}
            <span class="badge bg-danger ms-2"><i class="bi bi-youtube"></i> YouTube</span>
            {% endif %}
            {% endif %}
        </div>
        <div class="d-flex gap-2 align-items-center">
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'topic_finder' %}" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" name="manual_input" class="form-control form-control-sm" style="width: 400px;"
                       value="{{ topic.url|default:'' }}" placeholder="YouTube URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://youtube.com/watch?v=...)">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="bi bi-check-lg"></i> ì €ì¥
                </button>
            </form>
            {% if topic %}
            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#autoPipelineModal">
                <i class="bi bi-lightning-fill"></i> ìë™ ìƒì„±
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 2. YouTube ìˆ˜ì§‘ (YouTube URL ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
{% if topic.video_id %}
{% with exec_yt=step_executions|dict_get:'youtube_collector' %}
<div class="step-section {% if research.transcript %}has-data{% endif %}" id="youtube-collect-section">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#youtube-collect-body">
        <div>
            <strong>2. YouTube ìˆ˜ì§‘</strong>
            {% if exec_yt.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_yt.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ìˆ˜ì§‘ ì¤‘ {{ exec_yt.progress_percent }}%
            </a>
            {% elif research.transcript %}
            <span class="badge bg-success ms-2">ìˆ˜ì§‘ì™„ë£Œ</span>
            <span class="ms-2 text-muted">
                ìë§‰ {{ research.transcript|length }}ì
                {% if research.youtube_comments.count %}| ëŒ“ê¸€ {{ research.youtube_comments.count }}ê°œ{% endif %}
            </span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'youtube_collector' %}" class="d-inline ajax-step-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-youtube"></i> ìˆ˜ì§‘
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="youtube-collect-body">
        <div class="step-body">
            {% if research.transcript %}
            <div class="row">
                <div class="col-md-6">
                    <details class="mb-3" open>
                        <summary><strong>ìë§‰ ({{ research.transcript|length }}ì)</strong>
                            {% if research.transcript_is_auto %}<span class="badge bg-secondary ms-1">ìë™ìƒì„±</span>{% endif %}
                            {% if research.transcript_language %}<span class="badge bg-outline-secondary ms-1">{{ research.transcript_language }}</span>{% endif %}
                        </summary>
                        <div class="mt-2 p-2 bg-light rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.85em;">
                            {{ research.transcript|truncatechars:3000 }}
                        </div>
                    </details>
                </div>
                <div class="col-md-6">
                    {% if research.youtube_comments.count %}
                    <details class="mb-3">
                        <summary><strong>ëŒ“ê¸€ ({{ research.youtube_comments.count }}ê°œ)</strong></summary>
                        <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                            {% for comment in research.youtube_comments.all|slice:":20" %}
                            <div class="border-start border-2 {% if comment.is_highlighted %}border-warning{% else %}border-secondary{% endif %} ps-2 mb-2 small">
                                <strong>{{ comment.author }}</strong>
                                {% if comment.like_count %}<span class="text-primary ms-2">ğŸ‘ {{ comment.like_count|format_number }}</span>{% endif %}
                                {% if comment.is_highlighted %}<span class="badge bg-warning text-dark ms-1">ì£¼ìš”</span>{% endif %}
                                <br>{{ comment.text|truncatechars:200 }}
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">YouTube ìˆ˜ì§‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë§‰ê³¼ ëŒ“ê¸€ì„ ìˆ˜ì§‘í•˜ì„¸ìš”.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 3. ìë§‰ ë¶„ì„ -->
{% with exec_ta=step_executions|dict_get:'transcript_analyzer' %}
<div class="step-section {% if research.content_analysis.transcript_analysis %}has-data{% endif %}" id="transcript-analysis-section">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#transcript-analysis-body">
        <div>
            <strong>3. ìë§‰ ë¶„ì„</strong>
            {% if exec_ta.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_ta.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ë¶„ì„ ì¤‘ {{ exec_ta.progress_percent }}%
            </a>
            {% elif research.content_analysis.transcript_analysis %}
            <span class="badge bg-success ms-2">ë¶„ì„ì™„ë£Œ</span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-outline-secondary" onclick="openPromptModal('transcript_analyzer', 'ìë§‰ ë¶„ì„')">
                <i class="bi bi-sliders"></i> í”„ë¡¬í”„íŠ¸
            </button>
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'transcript_analyzer' %}" class="d-inline ms-2 ajax-step-form">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="2.5-flash" selected>2.5 Flash</option>
                    <option value="2.5-pro">2.5 Pro</option>
                    <option value="flash">3 Flash</option>
                    <option value="pro">3 Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary" {% if not research.transcript %}disabled{% endif %}>
                    <i class="bi bi-file-text"></i> ë¶„ì„
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="transcript-analysis-body">
        <div class="step-body">
            {% if research.content_analysis.transcript_analysis %}
            <div class="markdown-content" id="transcript-analysis-md"></div>
            <script type="text/plain" id="transcript-analysis-data">{{ research.content_analysis.transcript_analysis|safe }}</script>
            {% elif not research.transcript %}
            <p class="text-muted mb-0">YouTube ìˆ˜ì§‘ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
            {% else %}
            <p class="text-muted mb-0">ìë§‰ ë¶„ì„ì„ ì‹¤í–‰í•˜ë©´ ë°ì´í„°, ì¸ë¬¼, íƒ€ì„ë¼ì¸ ë“±ì´ ì¶”ì¶œë©ë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 4. ëŒ“ê¸€ ë¶„ì„ -->
{% with exec_ca=step_executions|dict_get:'comment_analyzer' %}
<div class="step-section {% if research.content_analysis.comment_analysis %}has-data{% endif %}" id="comment-analysis-section">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#comment-analysis-body">
        <div>
            <strong>4. ëŒ“ê¸€ ë¶„ì„</strong>
            {% if exec_ca.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_ca.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ë¶„ì„ ì¤‘ {{ exec_ca.progress_percent }}%
            </a>
            {% elif research.content_analysis.comment_analysis %}
            <span class="badge bg-success ms-2">ë¶„ì„ì™„ë£Œ</span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-outline-secondary" onclick="openPromptModal('comment_analyzer', 'ëŒ“ê¸€ ë¶„ì„')">
                <i class="bi bi-sliders"></i> í”„ë¡¬í”„íŠ¸
            </button>
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'comment_analyzer' %}" class="d-inline ms-2 ajax-step-form">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="2.5-flash" selected>2.5 Flash</option>
                    <option value="2.5-pro">2.5 Pro</option>
                    <option value="flash">3 Flash</option>
                    <option value="pro">3 Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-info" {% if not research.youtube_comments.count %}disabled{% endif %}>
                    <i class="bi bi-chat-dots"></i> ë¶„ì„
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="comment-analysis-body">
        <div class="step-body">
            {% if research.content_analysis.comment_analysis %}
            <div class="markdown-content" id="comment-analysis-md"></div>
            <script type="text/plain" id="comment-analysis-data">{{ research.content_analysis.comment_analysis|safe }}</script>
            {% elif not research.youtube_comments.count %}
            <p class="text-muted mb-0">YouTube ìˆ˜ì§‘ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
            {% else %}
            <p class="text-muted mb-0">ëŒ“ê¸€ ë¶„ì„ì„ ì‹¤í–‰í•˜ë©´ ì²­ì¤‘ ìš•êµ¬ê°€ ì¶”ì¶œë©ë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 5. ëŒ€ë³¸ ê³„íš -->
{% with exec_sp=step_executions|dict_get:'script_planner' %}
<div class="step-section {% if research.content_analysis.script_plan %}has-data{% endif %}" id="script-plan-section">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#script-plan-body">
        <div>
            <strong>5. ëŒ€ë³¸ ê³„íš</strong>
            {% if exec_sp.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_sp.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ê³„íš ì¤‘ {{ exec_sp.progress_percent }}%
            </a>
            {% elif research.content_analysis.script_plan %}
            <span class="badge bg-success ms-2">ê³„íšì™„ë£Œ</span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-outline-secondary" onclick="openPromptModal('script_planner', 'ëŒ€ë³¸ ê³„íš')">
                <i class="bi bi-sliders"></i> í”„ë¡¬í”„íŠ¸
            </button>
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'script_planner' %}" class="d-inline ms-2 ajax-step-form">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="2.5-flash" selected>2.5 Flash</option>
                    <option value="2.5-pro">2.5 Pro</option>
                    <option value="flash">3 Flash</option>
                    <option value="pro">3 Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-success" {% if not research.content_analysis.transcript_analysis or not research.content_analysis.comment_analysis %}disabled{% endif %}>
                    <i class="bi bi-diagram-3"></i> ê³„íš
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="script-plan-body">
        <div class="step-body">
            {% if research.content_analysis.script_plan %}
            <div class="markdown-content" id="script-plan-md"></div>
            <script type="text/plain" id="script-plan-data">{{ research.content_analysis.script_plan|safe }}</script>
            {% elif not research.content_analysis.transcript_analysis or not research.content_analysis.comment_analysis %}
            <p class="text-muted mb-0">ìë§‰ ë¶„ì„ê³¼ ëŒ“ê¸€ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
            {% else %}
            <p class="text-muted mb-0">ëŒ€ë³¸ ê³„íšì„ ì‹¤í–‰í•˜ë©´ ì „ì²´ êµ¬ì¡°ê°€ ì„¤ê³„ë©ë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}
{% endif %}

<!-- 6. ë¦¬ì„œì¹˜ -->
{% with exec=step_executions|dict_get:'researcher' %}
<div class="step-section {% if research.content_analysis.research_result %}has-data{% endif %}" id="research">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#research-body">
        <div>
            <strong>6. ë¦¬ì„œì¹˜</strong>
            {% if exec.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì§„í–‰ ì¤‘ ({{ exec.progress_percent }}%)
            </a>
            {% elif research.content_analysis.research_result %}
            <span class="badge bg-success ms-2">ì™„ë£Œ</span>
            {% endif %}
            {% if exec.total_tokens %}
            <small class="ms-2 text-primary">{{ exec.total_tokens }} í† í° / ${{ exec.estimated_cost }}</small>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-outline-secondary" onclick="openPromptModal('researcher', 'Researcher')">
                <i class="bi bi-sliders"></i> í”„ë¡¬í”„íŠ¸
            </button>
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'researcher' %}" class="d-inline ajax-step-form">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="2.5-flash" selected>2.5 Flash</option>
                    <option value="2.5-pro">2.5 Pro</option>
                    <option value="flash">3 Flash</option>
                    <option value="pro">3 Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-search"></i> {% if research.content_analysis.research_result %}ì¬ì‹¤í–‰{% else %}ì‹¤í–‰{% endif %}
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="research-body">
        <div class="step-body">
            {% if research.content_analysis.research_result %}
            <!-- ë¦¬ì„œì¹˜ ê²°ê³¼ (Markdown) -->
            <div class="markdown-content" id="research-result-md"></div>
            <script type="text/plain" id="research-result-data">{{ research.content_analysis.research_result|safe }}</script>
            {% else %}
            <p class="text-muted mb-0">ë¨¼ì € 5. ëŒ€ë³¸ ê³„íšì„ ì‹¤í–‰í•œ í›„ ë¦¬ì„œì¹˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p>
            {% endif %}

            <!-- ìˆ˜ë™ ìë£Œ ì…ë ¥ -->
            <hr class="my-3">
            <details class="mb-2" {% if research.manual_notes %}open{% endif %}>
                <summary><strong><i class="bi bi-pencil-square"></i> ìˆ˜ë™ ìë£Œ ì…ë ¥</strong>
                    <small class="text-muted ms-2">(ë¦¬ì„œì¹˜ ì—†ì´ ëŒ€ë³¸ ì‘ì„± ê°€ëŠ¥)</small>
                </summary>
                <div class="mt-3">
                    <p class="small text-muted mb-2">
                        ì§ì ‘ ì°¸ê³  ìë£Œë¥¼ ì…ë ¥í•˜ë©´ ë¦¬ì„œì¹˜ ë‹¨ê³„ ì—†ì´ ë°”ë¡œ ëŒ€ë³¸ ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                        ê¸°ì¡´ ë¦¬ì„œì¹˜ ìë£Œì™€ í•¨ê»˜ ì‚¬ìš©ë©ë‹ˆë‹¤.
                    </p>
                    <textarea class="form-control" id="manual-notes" rows="8"
                        placeholder="ì°¸ê³  ìë£Œ, ì¸ìš©êµ¬, ìˆ«ì/í†µê³„, ê¸°ì‚¬ ë‚´ìš© ë“±ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”...">{{ research.manual_notes|default:'' }}</textarea>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">
                            <span id="manual-notes-count">{{ research.manual_notes|length|default:0 }}</span>ì
                        </small>
                        <button class="btn btn-sm btn-primary" onclick="saveManualNotes()">
                            <i class="bi bi-save"></i> ìˆ˜ë™ ìë£Œ ì €ì¥
                        </button>
                    </div>
                </div>
            </details>
        </div>
    </div>
</div>
{% endwith %}

<!-- 3. ëŒ€ë³¸ -->
{% with exec=step_executions|dict_get:'script_writer' %}
<div class="step-section {% if draft %}has-data{% endif %}" id="draft">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#draft-body">
        <div>
            <strong>7. ëŒ€ë³¸</strong>
            {% if exec.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì§„í–‰ ì¤‘ ({{ exec.progress_percent }}%)
            </a>
            {% elif draft %}
            <span class="badge bg-{% if draft.char_count >= 7500 and draft.char_count <= 8500 %}success{% elif draft.char_count >= 7000 %}warning{% else %}danger{% endif %} ms-2">
                {{ draft.char_count }}ì
            </span>
            <span class="ms-2 text-muted">{{ draft.title|truncatechars:40 }}</span>
            {% endif %}
            {% if exec.total_tokens %}
            <small class="ms-2 text-primary">{{ exec.total_tokens }} í† í° / ${{ exec.estimated_cost }}</small>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <button class="btn btn-sm btn-outline-secondary" onclick="openPromptModal('script_writer', 'Script Writer')">
                <i class="bi bi-sliders"></i> í”„ë¡¬í”„íŠ¸
            </button>
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'script_writer' %}" class="d-inline ajax-step-form">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="2.5-flash">2.5 Flash</option>
                    <option value="2.5-pro" selected>2.5 Pro</option>
                    <option value="flash">3 Flash</option>
                    <option value="pro">3 Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> {% if draft %}ì¬ìƒì„±{% else %}ìƒì„±{% endif %}
                </button>
            </form>
        </div>
    </div>
    <div class="collapse" id="draft-body">
        <div class="step-body">
            <div class="mb-2 d-flex justify-content-between align-items-center">
                <div>
                    <span class="char-counter {% if draft.char_count >= 7500 and draft.char_count <= 8500 %}good{% elif draft.char_count >= 7000 %}warning{% else %}danger{% endif %}" id="draft-char-count">
                        {{ draft.char_count|default:0 }}ì
                    </span>
                    <small class="text-muted">/ ëª©í‘œ 7,500~8,500ì</small>
                </div>
                <button class="btn btn-sm btn-success" id="save-draft-btn" onclick="saveDraft()" disabled>
                    <i class="bi bi-check-lg"></i> ì €ì¥
                </button>
            </div>
            <input type="text" class="form-control form-control-sm mb-2" id="draft-title"
                   value="{{ draft.title|default:'' }}" placeholder="ì œëª©" onchange="enableSave()">
            <textarea class="form-control" id="draft-content" rows="20"
                      style="font-family: monospace; font-size: 0.9em; line-height: 1.8;"
                      placeholder="ëŒ€ë³¸ ë‚´ìš©..." oninput="updateCharCount()">{{ draft.content|default:'' }}</textarea>
        </div>
    </div>
</div>
{% endwith %}

<!-- 4. ì”¬ ë¶„í•  + ì”¬ ëª©ë¡ -->
{% with exec_planner=step_executions|dict_get:'scene_planner' exec_prompter=step_executions|dict_get:'image_prompter' exec_generator=step_executions|dict_get:'scene_generator' exec_tts=step_executions|dict_get:'tts_generator' %}
<div class="step-section {% if scenes.count > 0 %}has-data{% endif %}" id="scenes">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#scenes-body">
        <div>
            <strong>8. ì”¬ ê´€ë¦¬</strong>
            {% if scenes.count > 0 %}
            <span class="badge bg-success ms-2">{{ scenes.count }}ê°œ ì”¬</span>
            {% endif %}
            <!-- ì§„í–‰ ì¤‘ì¸ ì‘ì—… í‘œì‹œ -->
            {% if exec_planner.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_planner.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì”¬ë¶„í•  {{ exec_planner.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_prompter.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_prompter.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> í”„ë¡¬í”„íŠ¸ {{ exec_prompter.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_generator.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_generator.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì´ë¯¸ì§€ {{ exec_generator.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_tts.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_tts.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> TTS {{ exec_tts.progress_percent }}%
            </a>
            {% endif %}
            <!-- í† í° ì‚¬ìš©ëŸ‰ í‘œì‹œ -->
            {% if exec_planner.total_tokens or exec_prompter.total_tokens or exec_generator.total_tokens or exec_tts.total_tokens %}
            <small class="ms-2 text-primary">
                {% if exec_planner.total_tokens %}ì”¬: {{ exec_planner.total_tokens|floatformat:0 }}t (${{ exec_planner.estimated_cost }}){% endif %}
                {% if exec_prompter.total_tokens %} | í”„ë¡¬í”„íŠ¸: {{ exec_prompter.total_tokens|floatformat:0 }}t (${{ exec_prompter.estimated_cost }}){% endif %}
                {% if exec_generator.total_tokens %} | ì´ë¯¸ì§€: {{ exec_generator.total_tokens|floatformat:0 }}t (${{ exec_generator.estimated_cost }}){% endif %}
                {% if exec_tts.total_tokens %} | TTS: {{ exec_tts.total_tokens|floatformat:0 }}t{% endif %}
            </small>
            {% endif %}
        </div>
    </div>
    <div class="collapse" id="scenes-body">
        <div class="step-body p-0">
            <!-- ì”¬ ì‘ì—… ë²„íŠ¼ -->
            <div class="p-2 border-bottom bg-light">
                <div class="d-flex flex-wrap gap-3 align-items-center" style="font-size: 0.9em;">
                    <!-- ì”¬ ë¶„í•  -->
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk 'scene_planner' %}" class="d-inline ajax-step-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-grid-3x3"></i> ì”¬ ë¶„í•  ìƒˆë¡œí•˜ê¸°
                        </button>
                    </form>

                    <!-- ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ -->
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk 'image_prompter' %}" class="ajax-step-form">
                        {% csrf_token %}
                        <span class="me-1">ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ :</span>
                        <select name="model_type" class="form-select form-select-sm d-inline" style="width: auto;">
                            <option value="2.5-flash" selected>2.5 Flash</option>
                            <option value="2.5-pro">2.5 Pro</option>
                            <option value="flash">3 Flash</option>
                            <option value="pro">3 Pro</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-info" {% if scenes.count == 0 %}disabled{% endif %}>
                            ìƒì„±
                        </button>
                        <label class="form-check-inline mb-0 ms-1" style="font-size: 0.85em;">
                            <input type="checkbox" name="no_text" value="1" class="form-check-input">
                            <span>í•œê¸€ê¸ˆì§€</span>
                        </label>
                    </form>

                    <!-- TTS ë¬¸êµ¬ -->
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk 'tts_converter' %}" class="ajax-step-form">
                        {% csrf_token %}
                        <span class="me-1">TTS ë¬¸êµ¬ :</span>
                        <select name="model_type" class="form-select form-select-sm d-inline" style="width: auto;">
                            <option value="2.5-flash" selected>2.5 Flash</option>
                            <option value="2.5-pro">2.5 Pro</option>
                            <option value="flash">3 Flash</option>
                            <option value="pro">3 Pro</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-primary" {% if scenes.count == 0 %}disabled{% endif %}>
                            ìƒì„±
                        </button>
                    </form>

                    <!-- ì´ë¯¸ì§€ ìƒì„± -->
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk 'scene_generator' %}" class="d-inline ajax-step-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-success" {% if scenes.count == 0 %}disabled{% endif %}>
                            <i class="bi bi-images"></i> ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°
                        </button>
                    </form>

                    <!-- TTS ìƒì„± -->
                    <form method="post" action="{% url 'pipeline:step_execute' project.pk 'tts_generator' %}" class="d-inline ajax-step-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-info" {% if scenes.count == 0 %}disabled{% endif %}>
                            <i class="bi bi-mic"></i> TTS ìƒì„±í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>

            {% if scenes.count > 0 %}
            <!-- ì‚­ì œ ë²„íŠ¼ -->
            <div class="d-flex gap-2 p-2 border-bottom" style="background: #fff8f8;">
                <button class="btn btn-sm btn-outline-info" onclick="deleteMismatchAudio()">
                    <i class="bi bi-arrow-repeat"></i> ë¶ˆì¼ì¹˜ TTS ì¬ìƒì„±
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="deleteAllImagePrompts()">
                    <i class="bi bi-trash"></i> ì´ë¯¸ì§€í”„ë¡¬í”„íŠ¸ ì‚­ì œ
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="deleteAllTtsText()">
                    <i class="bi bi-trash"></i> TTSí…ìŠ¤íŠ¸ ì‚­ì œ
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAllImages()">
                    <i class="bi bi-trash"></i> ì´ë¯¸ì§€ ì „ì²´ ì‚­ì œ
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAllAudio()">
                    <i class="bi bi-trash"></i> ì˜¤ë””ì˜¤ ì „ì²´ ì‚­ì œ
                </button>
            </div>
            <!-- ì”¬ í—¤ë” -->
            <div class="scene-card" style="background: #f8f9fa; font-weight: bold; font-size: 0.85em; padding: 8px 16px;">
                <div>#</div>
                <div>ë‚˜ë ˆì´ì…˜</div>
                <div>ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</div>
                <div>ì´ë¯¸ì§€</div>
                <div>ì˜¤ë””ì˜¤</div>
                <div>ìë§‰</div>
                <div>ì•¡ì…˜</div>
            </div>
            <!-- ì”¬ ì¹´ë“œ ëª©ë¡ -->
            <div class="scene-list">
                {% for scene in scenes %}
                <div class="scene-card" id="scene-{{ scene.scene_number }}">
                    <div class="scene-number">
                        <strong>{{ scene.scene_number }}.</strong>
                        <label class="mb-0" style="cursor: pointer;" title="ìºë¦­í„° ë“±ì¥ í† ê¸€">
                            <input type="checkbox" class="form-check-input"
                                   {% if scene.has_character %}checked{% endif %}
                                   onchange="toggleCharacter({{ scene.scene_number }}, this.checked)">
                        </label>
                    </div>
                    <div class="scene-narration">
                        <div class="narration-text editable-text"
                             contenteditable="true"
                             data-scene="{{ scene.scene_number }}"
                             data-field="narration"
                             onblur="saveField(this)"
                             onkeydown="handleEditKey(event, this)">{{ scene.narration }}</div>
                        <div class="tts-text mt-1 editable-text"
                             contenteditable="true"
                             data-scene="{{ scene.scene_number }}"
                             data-field="narration_tts"
                             onblur="saveField(this)"
                             onkeydown="handleEditKey(event, this)"
                             style="font-size: 0.75em; color: #888;">{% if scene.narration_tts %}{{ scene.narration_tts }}{% else %}<span class="text-muted fst-italic">TTS ì—†ìŒ</span>{% endif %}</div>
                    </div>
                    <div class="scene-prompt">
                        <div class="prompt-text editable-text"
                             contenteditable="true"
                             data-scene="{{ scene.scene_number }}"
                             data-field="image_prompt"
                             onblur="saveField(this)"
                             onkeydown="handleEditKey(event, this)"
                             {% if not scene.image_prompt %}data-placeholder="(í´ë¦­í•˜ì—¬ í”„ë¡¬í”„íŠ¸ ì…ë ¥)"{% endif %}>{{ scene.image_prompt|default:"" }}</div>
                    </div>
                    <div class="scene-image">
                        {% if scene.image %}
                        <img src="{{ scene.image.url }}" alt="ì”¬ {{ scene.scene_number }}" class="scene-thumbnail" onclick="previewImage('{{ scene.image.url }}')">
                        {% if scene.video %}
                        <div class="video-overlay" onclick="event.stopPropagation(); previewVideo('{{ scene.video.url }}', {{ scene.scene_number }})" title="ì¸íŠ¸ë¡œ ì˜ìƒ ì¬ìƒ">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="image-placeholder">
                            <i class="bi bi-image text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="scene-audio" id="audio-container-{{ scene.scene_number }}">
                        {% if scene.audio %}
                        <audio controls preload="none">
                            <source src="{{ scene.audio.url }}" type="audio/wav">
                        </audio>
                        {% else %}
                        <span class="text-muted" style="font-size: 0.8em;"><i class="bi bi-mic-mute"></i> ì—†ìŒ</span>
                        {% endif %}
                    </div>
                    <div class="subtitle-status {{ scene.subtitle_status }}" id="subtitle-status-{{ scene.scene_number }}">
                        {% if scene.subtitle_status == 'matched' %}
                        <i class="bi bi-check-circle-fill text-success"></i><br>
                        {{ scene.subtitle_word_count }}ì
                        {% elif scene.subtitle_status == 'mismatch' %}
                        <i class="bi bi-exclamation-triangle-fill text-warning"></i><br>
                        {{ scene.subtitle_word_count }}/{{ scene.narration_word_count }}
                        {% elif scene.subtitle_status == 'incomplete' %}
                        <i class="bi bi-x-circle-fill text-danger"></i><br>
                        {{ scene.subtitle_word_count }}/{{ scene.narration_word_count }} ë¶ˆì™„ì „
                        {% elif scene.audio %}
                        <i class="bi bi-question-circle text-warning"></i><br>
                        ë¯¸ê²€ì¦
                        {% else %}
                        <i class="bi bi-dash-circle text-muted"></i><br>
                        -
                        {% endif %}
                    </div>
                    <div class="scene-actions">
                        <div class="btn-group btn-group-sm">
                            <button class="btn {% if scene.image %}btn-outline-warning{% else %}btn-outline-primary{% endif %}"
                                    onclick="generateSceneImage({{ scene.scene_number }}, 'pro')"
                                    title="Pro ëª¨ë¸ë¡œ ìƒì„±">
                                <i class="bi bi-image"></i>
                            </button>
                            <button class="btn {% if scene.image %}btn-outline-warning{% else %}btn-outline-primary{% endif %} dropdown-toggle dropdown-toggle-split"
                                    data-bs-toggle="dropdown" title="ëª¨ë¸ ì„ íƒ">
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'pro'); return false;">Gemini Pro ($0.134)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'flash'); return false;">Gemini Flash ($0.039)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'flux'); return false;">FLUX.1-schnell ($0.003)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'sdxl'); return false;">SDXL ($0.005)</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-sm {% if scene.audio %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                                onclick="generateSceneTTS({{ scene.scene_number }})"
                                title="{% if scene.audio %}TTS ì¬ìƒì„±{% else %}TTS ìƒì„±{% endif %}">
                            <i class="bi bi-mic"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger"
                                onclick="deleteScene({{ scene.scene_number }})"
                                title="ì‚­ì œ">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-grid-3x3-gap display-4"></i>
                <p class="mt-2">ëŒ€ë³¸ì„ ê¸°ë°˜ìœ¼ë¡œ ì”¬ì„ ë¶„í• í•˜ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 5. ì˜ìƒ ì œì‘ -->
{% with exec_video=step_executions|dict_get:'video_generator' exec_compose=step_executions|dict_get:'video_composer' exec_thumb=step_executions|dict_get:'thumbnail_generator' %}
<div class="step-section" id="video">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#video-body">
        <div>
            <strong>9. ì˜ìƒ ì œì‘</strong>
            {% if project.final_video %}
            <span class="badge bg-success ms-2">ì™„ë£Œ</span>
            {% endif %}
            <!-- ì§„í–‰ ì¤‘ì¸ ì‘ì—… í‘œì‹œ -->
            {% if exec_video.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_video.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì¸íŠ¸ë¡œ {{ exec_video.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_compose.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_compose.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> í¸ì§‘ {{ exec_compose.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_thumb.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_thumb.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> ì¸ë„¤ì¼ {{ exec_thumb.progress_percent }}%
            </a>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <!-- ì¸íŠ¸ë¡œ ë™ì˜ìƒ (ì”¬ ê°œìˆ˜ ì„ íƒ) -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'video_generator' %}" class="d-inline ajax-step-form">
                {% csrf_token %}
                <div class="input-group input-group-sm d-inline-flex" style="width: auto;">
                    <select name="scene_count" class="form-select form-select-sm" style="width: auto;">
                        <option value="4" selected>4ì”¬</option>
                        <option value="6">6ì”¬</option>
                        <option value="8">8ì”¬</option>
                        <option value="10">10ì”¬</option>
                        <option value="12">12ì”¬</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-film"></i> ì¸íŠ¸ë¡œì˜ìƒ
                    </button>
                </div>
            </form>
            <!-- ìµœì¢… í¸ì§‘ -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'video_composer' %}" class="d-inline ms-1 ajax-step-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-camera-video"></i> ìµœì¢…í¸ì§‘
                </button>
            </form>
            <!-- ì¸ë„¤ì¼ -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'thumbnail_generator' %}" class="d-inline ms-1 ajax-step-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-card-image"></i> ì¸ë„¤ì¼
                </button>
            </form>
            <!-- ì„ì‹œ íŒŒì¼ ì‚­ì œ -->
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFinalVideo()" title="ì„ì‹œ í´ë¦½, ASS ìë§‰ ë“± ì‚­ì œ">
                <i class="bi bi-trash"></i> ì´ˆê¸°í™”
            </button>
        </div>
    </div>
    <div class="collapse" id="video-body">
        <div class="step-body">
            <div class="row">
                {% if project.final_video %}
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">ìµœì¢… ì˜ìƒ</h6>
                        <a href="{{ project.final_video.url }}" download="{{ project.name }}_final.mp4" class="btn btn-sm btn-success" title="ì˜ìƒ ë‹¤ìš´ë¡œë“œ">
                            <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                    <video controls class="w-100" style="max-height: 400px;">
                        <source src="{{ project.final_video.url }}" type="video/mp4">
                    </video>
                </div>
                {% endif %}
                {% if project.thumbnail %}
                <div class="col-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">ì¸ë„¤ì¼</h6>
                        <a href="{{ project.thumbnail.url }}" download="{{ project.name }}_thumbnail.png" class="btn btn-sm btn-outline-success" title="ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                    <img src="{{ project.thumbnail.url }}" class="img-fluid">
                </div>
                {% endif %}
                {% if project.full_subtitles %}
                <div class="col-12 mt-3">
                    <a href="{{ project.full_subtitles.url }}" download="{{ project.name }}_subtitles.srt" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-file-text"></i> ì „ì²´ ìë§‰ ë‹¤ìš´ë¡œë“œ (SRT)
                    </a>
                </div>
                {% endif %}
                {% if not project.final_video and not project.thumbnail %}
                <div class="col-12 text-muted">
                    ì”¬ ì´ë¯¸ì§€ ìƒì„± í›„ ì˜ìƒì„ ì œì‘í•˜ì„¸ìš”.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endwith %}

<!-- 6. ì—…ë¡œë“œ ì •ë³´ -->
<div class="step-section" id="upload">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#upload-body">
        <div>
            <strong>10. ì—…ë¡œë“œ ì •ë³´</strong>
            {% if project.upload_info %}
            <span class="badge bg-success ms-2">ì„¤ì •ë¨</span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();" class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" id="upload-model-select" style="width: auto;">
                <option value="flash">Flash (ë¹ ë¦„)</option>
                <option value="pro">Pro (ê³ í’ˆì§ˆ)</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="generateUploadInfo()">
                <i class="bi bi-magic"></i> ìë™ ìƒì„±
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="saveUploadInfo()">
                <i class="bi bi-save"></i> ì €ì¥
            </button>
            <span id="upload-token-info" class="small text-muted"></span>
        </div>
    </div>
    <div class="collapse" id="upload-body">
        <div class="step-body">
            <div class="row">
                <!-- ì™¼ìª½: ì…ë ¥ í¼ -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì œëª© (70ì ì´ë‚´)</label>
                        <input type="text" class="form-control" id="upload-title" maxlength="100"
                            value="{{ project.upload_info.title|default:'' }}"
                            placeholder="ì˜ìƒ ì œëª©">
                        <small class="text-muted">í˜„ì¬: <span id="title-count">0</span>/70ì</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì„¤ëª…</label>
                        <textarea class="form-control" id="upload-description" rows="4"
                            placeholder="ì˜ìƒ ì„¤ëª… (íƒ€ì„ë¼ì¸, í•´ì‹œíƒœê·¸ ìë™ ì¶”ê°€ë¨)">{{ project.upload_info.description|default:'' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" class="form-control" id="upload-tags"
                            value="{{ project.upload_info.get_tags_string|default:'' }}"
                            placeholder="ê²½ì œ, ìì˜ì—…, ì¬í…Œí¬, ...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">íƒ€ì„ë¼ì¸</label>
                        <div class="bg-light p-2 rounded small" id="upload-timeline">
                            {% if project.upload_info and project.upload_info.timeline %}
                            {% for item in project.upload_info.timeline %}
                            {{ item.time }} {{ item.title }}<br>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">"ìë™ ìƒì„±" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒì„±ë©ë‹ˆë‹¤.</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì¸ë„¤ì¼ -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼</label>
                        <select class="form-select" id="thumbnail-style-select">
                            <option value="">ìŠ¤íƒ€ì¼ ì„ íƒ ì•ˆí•¨</option>
                            {% for style in thumbnail_styles %}
                            <option value="{{ style.pk }}" {% if project.thumbnail_style_id == style.pk %}selected{% endif %}>
                                {{ style.name }} ({{ style.get_style_type_display }}){% if style.is_default %} - ê¸°ë³¸{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">ì˜ˆì‹œ ì´ë¯¸ì§€ë¥¼ ì°¸ê³ í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸</label>
                        <textarea class="form-control" id="thumbnail-prompt" rows="5"
                            placeholder="ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸">{{ project.upload_info.thumbnail_prompt|default:'' }}</textarea>
                    </div>
                    <button class="btn btn-warning mb-3" onclick="generateThumbnail()">
                        <i class="bi bi-image"></i> ì¸ë„¤ì¼ ìƒì„±
                    </button>
                    <div id="thumbnail-preview">
                        {% if project.thumbnail %}
                        <img src="{{ project.thumbnail.url }}" class="img-fluid rounded shadow">
                        <div class="mt-2">
                            <a href="{{ project.thumbnail.url }}" download class="btn btn-sm btn-outline-success">
                                <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                            </a>
                        </div>
                        {% else %}
                        <div class="bg-light p-5 text-center rounded">
                            <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">ì¸ë„¤ì¼ì„ ìƒì„±í•˜ì„¸ìš”</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ì „ì²´ ì„¤ëª… ë¯¸ë¦¬ë³´ê¸° -->
            <div class="mt-4">
                <label class="form-label fw-bold">ì „ì²´ ì„¤ëª… ë¯¸ë¦¬ë³´ê¸° (ë³µì‚¬ìš©)</label>
                <textarea class="form-control bg-light" id="full-description" rows="10" readonly
                    onclick="this.select()">{{ project.upload_info.get_full_description|default:'' }}</textarea>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyFullDescription()">
                    <i class="bi bi-clipboard"></i> ë³µì‚¬
                </button>
            </div>
        </div>
    </div>
</div>

<!-- í† í° ì‚¬ìš©ëŸ‰ ìš”ì•½ -->
{% if total_tokens > 0 %}
<div class="card mt-4 border-info">
    <div class="card-header bg-info text-white py-2">
        <i class="bi bi-graph-up"></i> <strong>í† í° ì‚¬ìš©ëŸ‰ ìš”ì•½</strong>
    </div>
    <div class="card-body py-2">
        <div class="row small">
            {% for step_name, exec in step_executions.items %}
            {% if exec.total_tokens > 0 and step_name != 'auto_pipeline' %}
            <div class="col-md-4 col-lg-3 mb-2">
                <span class="text-muted">{{ exec.step.display_name }}:</span><br>
                <strong>{{ exec.total_tokens|floatformat:0 }}</strong> í† í°
                <span class="text-success">(${{ exec.estimated_cost }})</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-calculator"></i>
                <strong>ì´ í† í°: {{ total_tokens|floatformat:0 }}</strong>
            </span>
            <span class="text-success fs-5">
                <strong>ì´ ë¹„ìš©: ${{ total_cost }}</strong>
            </span>
        </div>
    </div>
</div>
{% endif %}

<!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
            </div>
        </div>
    </div>
</div>

<!-- ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì”¬ <span id="videoSceneNum"></span> ì¸íŠ¸ë¡œ ì˜ìƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <video id="previewVideo" controls class="w-100" style="max-height: 70vh;">
                    <source src="" type="video/mp4">
                </video>
            </div>
        </div>
    </div>
</div>

<!-- í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders"></i> <span id="promptModalTitle">í”„ë¡¬í”„íŠ¸ ìˆ˜ì •</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 mb-3">
                    <i class="bi bi-info-circle"></i>
                    í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ë©´ <strong>ë‚´ ê³„ì •ì—ë§Œ</strong> ì ìš©ë©ë‹ˆë‹¤.
                    <span id="promptCustomBadge" class="badge bg-success ms-2" style="display: none;">ì»¤ìŠ¤í…€ ì‚¬ìš© ì¤‘</span>
                </div>
                <textarea id="promptContent" class="form-control" rows="25"
                    style="font-family: monospace; font-size: 0.85em; line-height: 1.6;"></textarea>
                <input type="hidden" id="promptAgentName" value="">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-warning" onclick="resetPrompt()">
                    <i class="bi bi-arrow-counterclockwise"></i> ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="savePrompt()">
                        <i class="bi bi-save"></i> ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="stepToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle me-2"></i>
                <span id="toastMessage">ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// ì™„ë£Œ ì•Œë¦¼ìŒ ì¬ìƒ
function playSuccessSound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        // ìƒì¾Œí•œ 2ìŒ ì•Œë¦¼ìŒ
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
        oscillator.frequency.setValueAtTime(1108.73, audioCtx.currentTime + 0.1); // C#6

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
    } catch (e) {
        console.log('Audio not supported');
    }
}

// í† ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
function showToast(message, type = 'success') {
    const toast = document.getElementById('stepToast');
    const toastMessage = document.getElementById('toastMessage');

    toast.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning');
    toast.classList.add(`text-bg-${type}`);
    toastMessage.textContent = message;

    // ì„±ê³µ ì‹œ ì•Œë¦¼ìŒ
    if (type === 'success') {
        playSuccessSound();
    }

    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
}

// AJAX í¼ ì œì¶œ í•¸ë“¤ëŸ¬
document.querySelectorAll('.ajax-step-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message || 'ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // 1ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì‘ì—… ëª©ë¡ ì—…ë°ì´íŠ¸
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'ì‹¤í–‰ ì‹¤íŒ¨', 'danger');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            // JSON íŒŒì‹± ì‹¤íŒ¨ = ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
        }
    });
});

// ì‘ì—… ì·¨ì†Œ
document.querySelectorAll('.btn-cancel-exec').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const projectId = this.dataset.projectId;
        const execId = this.dataset.execId;

        fetch(`/pipeline/project/${projectId}/progress/${execId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'ì·¨ì†Œ ì‹¤íŒ¨');
            }
        })
        .catch(err => alert('ì˜¤ë¥˜: ' + err));
    });
});

// ì‘ì—… ì‚­ì œ
document.querySelectorAll('.btn-delete-exec').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('ì´ ì‘ì—… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const projectId = this.dataset.projectId;
        const execId = this.dataset.execId;

        fetch(`/pipeline/project/${projectId}/progress/${execId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
            }
        })
        .catch(err => alert('ì˜¤ë¥˜: ' + err));
    });
});

// ì™„ë£Œ ì‘ì—… í™•ì¸ (acknowledged ì²˜ë¦¬)
document.querySelectorAll('.btn-dismiss-exec').forEach(btn => {
    btn.addEventListener('click', function() {
        const projectId = this.dataset.projectId;
        const execId = this.dataset.execId;
        const item = this.closest('.work-item');

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch(`/pipeline/project/${projectId}/progress/${execId}/acknowledge/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // í•­ëª© ìˆ¨ê¸°ê¸°
                if (item) item.style.display = 'none';
                // ëª¨ë“  í•­ëª©ì´ ìˆ¨ê²¨ì¡Œìœ¼ë©´ ì¹´ë“œ ì „ì²´ ìˆ¨ê¸°ê¸°
                const visibleItems = document.querySelectorAll('.work-item:not([style*="display: none"])');
                if (visibleItems.length === 0) {
                    const card = document.getElementById('work-list-card');
                    if (card) card.style.display = 'none';
                }
            } else {
                alert(data.message || 'í™•ì¸ ì‹¤íŒ¨');
                location.reload();
            }
        })
        .catch(err => {
            alert('ì˜¤ë¥˜: ' + err);
            location.reload();
        });
    });
});

function updateCharCount() {
    const content = document.getElementById('draft-content');
    if (!content) return;

    const count = content.value.length;
    const counter = document.getElementById('draft-char-count');
    counter.textContent = count + 'ì';

    counter.classList.remove('good', 'warning', 'danger');
    if (count >= 7500 && count <= 8500) {
        counter.classList.add('good');
    } else if (count >= 7000) {
        counter.classList.add('warning');
    } else {
        counter.classList.add('danger');
    }

    enableSave();
}

function enableSave() {
    const btn = document.getElementById('save-draft-btn');
    if (btn) btn.disabled = false;
}

async function saveDraft() {
    const btn = document.getElementById('save-draft-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass"></i> ì €ì¥ ì¤‘...';

    const title = document.getElementById('draft-title').value;
    const content = document.getElementById('draft-content').value;

    try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('content', content);

        const response = await fetch('{% url "pipeline:draft_update" project.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            btn.innerHTML = '<i class="bi bi-check-lg"></i> ì €ì¥ë¨';
            document.getElementById('draft-char-count').textContent = data.char_count + 'ì';
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-check-lg"></i> ì €ì¥';
            }, 2000);
        } else {
            alert(data.message || 'ì €ì¥ ì‹¤íŒ¨');
            btn.innerHTML = '<i class="bi bi-check-lg"></i> ì €ì¥';
            btn.disabled = false;
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
        btn.innerHTML = '<i class="bi bi-check-lg"></i> ì €ì¥';
        btn.disabled = false;
    }
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
function previewImage(url) {
    document.getElementById('previewImg').src = url;
    new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
}

// ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°
function previewVideo(url, sceneNumber) {
    const video = document.getElementById('previewVideo');
    video.querySelector('source').src = url;
    video.load();
    document.getElementById('videoSceneNum').textContent = sceneNumber;

    const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
    modal.show();

    // ëª¨ë‹¬ ë‹«í ë•Œ ì˜ìƒ ì •ì§€
    document.getElementById('videoPreviewModal').addEventListener('hidden.bs.modal', function() {
        video.pause();
    }, { once: true });
}

// ì”¬ ì´ë¯¸ì§€ ìƒì„± (ê°œë³„)
async function generateSceneImage(sceneNumber, modelType = 'pro') {
    const modelNames = {
        'pro': 'Gemini Pro',
        'flash': 'Gemini Flash',
        'flux': 'FLUX.1-schnell',
        'sdxl': 'SDXL'
    };
    const modelName = modelNames[modelType] || modelType;
    if (!confirm(`ì”¬ ${sceneNumber}ì˜ ì´ë¯¸ì§€ë¥¼ ${modelName}ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const btn = event.target.closest('.btn-group') || event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    // btn-groupì´ë©´ ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
    const buttons = btn.querySelectorAll ? btn.querySelectorAll('button') : [btn];
    buttons.forEach(b => b.disabled = true);

    try {
        const formData = new FormData();
        formData.append('model_type', modelType);

        const response = await fetch(`{% url 'pipeline:scene_generate_image' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // ì´ë¯¸ì§€ ì˜ì—­ ì—…ë°ì´íŠ¸
            const sceneCard = document.getElementById(`scene-${sceneNumber}`);
            const imageDiv = sceneCard.querySelector('.scene-image');
            imageDiv.innerHTML = `<img src="${data.image_url}" alt="ì”¬ ${sceneNumber}" class="scene-thumbnail" onclick="previewImage('${data.image_url}')">`;
            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        } else {
            alert(data.message || 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
            btn.innerHTML = originalHtml;
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
        btn.innerHTML = originalHtml;
    }
    buttons.forEach(b => b.disabled = false);
}

// ì”¬ TTS ìƒì„± (ê°œë³„)
async function generateSceneTTS(sceneNumber) {
    if (!confirm(`ì”¬ ${sceneNumber}ì˜ TTSë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;

    try {
        const response = await fetch(`{% url 'pipeline:scene_generate_tts' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const data = await response.json();

        if (data.success) {
            // ì˜¤ë””ì˜¤ ì˜ì—­ ì—…ë°ì´íŠ¸
            const audioContainer = document.getElementById(`audio-container-${sceneNumber}`);
            audioContainer.innerHTML = `<audio controls preload="none"><source src="${data.audio_url}" type="audio/wav"></audio>`;

            // ìë§‰ ìƒíƒœ ì—…ë°ì´íŠ¸
            const subtitleStatus = document.getElementById(`subtitle-status-${sceneNumber}`);
            if (subtitleStatus) {
                subtitleStatus.className = `subtitle-status ${data.subtitle_status}`;
                if (data.subtitle_status === 'matched') {
                    subtitleStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i><br>${data.subtitle_word_count}ì`;
                } else if (data.subtitle_status === 'mismatch') {
                    subtitleStatus.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-warning"></i><br>${data.subtitle_word_count}/${data.narration_word_count}`;
                } else if (data.subtitle_status === 'incomplete') {
                    subtitleStatus.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i><br>${data.subtitle_word_count}/${data.narration_word_count} ë¶ˆì™„ì „`;
                } else {
                    subtitleStatus.innerHTML = `<i class="bi bi-dash-circle text-muted"></i><br>-`;
                }
            }

            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        } else {
            alert(data.message || 'TTS ìƒì„± ì‹¤íŒ¨');
            btn.innerHTML = originalHtml;
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
        btn.innerHTML = originalHtml;
    }
    btn.disabled = false;
}

// ì¸ë¼ì¸ í¸ì§‘ - í•„ë“œ ì €ì¥
let saveTimeout = null;
async function saveField(element) {
    const sceneNumber = element.dataset.scene;
    const field = element.dataset.field;
    const value = element.innerText.trim();

    // ì €ì¥ ì¤‘ í‘œì‹œ
    element.classList.remove('saved', 'error');
    element.classList.add('saving');

    try {
        const formData = new FormData();
        formData.append(field, value);

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });

        const data = await response.json();
        element.classList.remove('saving');

        if (data.success) {
            element.classList.add('saved');
            setTimeout(() => element.classList.remove('saved'), 1500);
        } else {
            element.classList.add('error');
            console.error('ì €ì¥ ì‹¤íŒ¨:', data.message);
        }
    } catch (error) {
        element.classList.remove('saving');
        element.classList.add('error');
        console.error('ì˜¤ë¥˜:', error.message);
    }
}

// í‚¤ ì…ë ¥ ì²˜ë¦¬ (Enterë¡œ ì €ì¥, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)
function handleEditKey(event, element) {
    if (event.key === 'Escape') {
        element.blur();
    }
}

// ìºë¦­í„° ë“±ì¥ í† ê¸€
async function toggleCharacter(sceneNumber, hasCharacter) {
    try {
        const formData = new FormData();
        formData.append('has_character', hasCharacter);

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });

        const data = await response.json();
        if (!data.success) {
            alert(data.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// ì”¬ ì‚­ì œ
async function deleteScene(sceneNumber) {
    if (!confirm(`ì”¬ ${sceneNumber}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ ì”¬ ë²ˆí˜¸ê°€ ì¬ì •ë ¬ë©ë‹ˆë‹¤.`)) return;

    try {
        const response = await fetch(`{% url 'pipeline:scene_delete' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// ì´ë¯¸ì§€ ì „ì²´ ì‚­ì œ
async function deleteAllImages() {
    if (!confirm('ëª¨ë“  ì”¬ì˜ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_images" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// ì˜¤ë””ì˜¤ ì „ì²´ ì‚­ì œ
async function deleteAllAudio() {
    if (!confirm('ëª¨ë“  ì”¬ì˜ ì˜¤ë””ì˜¤ì™€ ìë§‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_audio" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

async function deleteAllTtsText() {
    if (!confirm('ëª¨ë“  ì”¬ì˜ TTS í…ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_tts_text" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

async function deleteAllImagePrompts() {
    if (!confirm('ëª¨ë“  ì”¬ì˜ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_image_prompts" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

async function deleteMismatchAudio() {
    if (!confirm('ìë§‰ ë¶ˆì¼ì¹˜ ì”¬ì˜ TTSí…ìŠ¤íŠ¸ + ì˜¤ë””ì˜¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nì‚­ì œ í›„ [TTS ë¬¸êµ¬ ìƒì„±] â†’ [TTS ìƒì„±í•˜ê¸°] ìˆœì„œë¡œ ì‹¤í–‰í•˜ì„¸ìš”.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_mismatch_audio" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            if (data.count > 0) {
                alert(data.message + '\n\n[TTS ë¬¸êµ¬ ìƒì„±] â†’ [TTS ìƒì„±í•˜ê¸°] ìˆœì„œë¡œ ì‹¤í–‰í•˜ì„¸ìš”.');
                location.reload();
            } else {
                alert('ë¶ˆì¼ì¹˜ ì”¬ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        } else {
            alert(data.message || 'ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// ì˜ìƒ ì œì‘ ì´ˆê¸°í™” (ì„ì‹œ íŒŒì¼ ì‚­ì œ, ì”¬ ì˜ìƒì€ ìœ ì§€)
async function deleteFinalVideo() {
    if (!confirm('ì˜ìƒ í¸ì§‘ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤:\n\nâ€¢ ìµœì¢… ì˜ìƒ\nâ€¢ ì„ì‹œ í´ë¦½\nâ€¢ ASS ìë§‰\nâ€¢ ì „ì²´ ìë§‰\n\nâ€» ì”¬ ì˜ìƒ(ì¸íŠ¸ë¡œ)ì€ ìœ ì§€ë©ë‹ˆë‹¤.\n\nì‚­ì œ í›„ "ìµœì¢…í¸ì§‘"ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_final_video" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// =============================================
// ì—…ë¡œë“œ ì •ë³´ ê´€ë ¨
// =============================================

// ì œëª© ê¸€ììˆ˜ í‘œì‹œ
const uploadTitleInput = document.getElementById('upload-title');
const titleCountSpan = document.getElementById('title-count');

if (uploadTitleInput) {
    uploadTitleInput.addEventListener('input', function() {
        titleCountSpan.textContent = this.value.length;
        if (this.value.length > 70) {
            titleCountSpan.classList.add('text-danger');
        } else {
            titleCountSpan.classList.remove('text-danger');
        }
    });
    // ì´ˆê¸°ê°’ í‘œì‹œ
    titleCountSpan.textContent = uploadTitleInput.value.length;
}

// ì—…ë¡œë“œ ì •ë³´ ìë™ ìƒì„±
async function generateUploadInfo() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ì‹œì‘ ì¤‘...';

    // ëª¨ë¸ ì„ íƒ
    const modelType = document.getElementById('upload-model-select').value;
    const formData = new FormData();
    formData.append('model_type', modelType);

    try {
        const response = await fetch("{% url 'pipeline:generate_upload_info' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            showToast(data.message || 'ì—…ë¡œë“œ ì •ë³´ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'ìƒì„± ì‹¤íŒ¨', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜: ' + error.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ì—…ë¡œë“œ ì •ë³´ ì €ì¥
async function saveUploadInfo() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    const formData = new FormData();
    formData.append('title', document.getElementById('upload-title').value);
    formData.append('description', document.getElementById('upload-description').value);
    formData.append('tags', document.getElementById('upload-tags').value);
    formData.append('thumbnail_prompt', document.getElementById('thumbnail-prompt').value);

    try {
        const response = await fetch("{% url 'pipeline:upload_info' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            alert(data.message);
        } else {
            alert(data.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ì¸ë„¤ì¼ ìƒì„±
async function generateThumbnail() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ìƒì„± ì¤‘...';

    const prompt = document.getElementById('thumbnail-prompt').value;
    if (!prompt.trim()) {
        alert('ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }

    const formData = new FormData();
    formData.append('prompt', prompt);
    // ì„ íƒëœ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ ID ì¶”ê°€
    const styleSelect = document.getElementById('thumbnail-style-select');
    if (styleSelect && styleSelect.value) {
        formData.append('style_id', styleSelect.value);
    }

    try {
        const response = await fetch("{% url 'pipeline:generate_thumbnail' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            const previewDiv = document.getElementById('thumbnail-preview');
            previewDiv.innerHTML = `
                <img src="${data.thumbnail_url}" class="img-fluid rounded shadow">
                <div class="mt-2">
                    <a href="${data.thumbnail_url}" download class="btn btn-sm btn-outline-success">
                        <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                    </a>
                </div>
            `;
        } else {
            alert(data.message || 'ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ì „ì²´ ì„¤ëª… ë³µì‚¬
function copyFullDescription() {
    const textarea = document.getElementById('full-description');
    textarea.select();
    document.execCommand('copy');
    alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ì´ˆê¸° ê¸€ììˆ˜ í‘œì‹œ
document.addEventListener('DOMContentLoaded', updateCharCount);

// ìˆ˜ë™ ìë£Œ ê¸€ììˆ˜ í‘œì‹œ
const manualNotesTextarea = document.getElementById('manual-notes');
if (manualNotesTextarea) {
    manualNotesTextarea.addEventListener('input', function() {
        document.getElementById('manual-notes-count').textContent = this.value.length;
    });
}

// ìˆ˜ë™ ìë£Œ ì €ì¥
async function saveManualNotes() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...';

    const manualNotes = document.getElementById('manual-notes').value;

    try {
        const formData = new FormData();
        formData.append('manual_notes', manualNotes);

        const response = await fetch("{% url 'pipeline:research_manual_notes' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            btn.innerHTML = '<i class="bi bi-check-lg"></i> ì €ì¥ë¨';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } else {
            alert(data.message || 'ì €ì¥ ì‹¤íŒ¨');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// =============================================
// í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
// =============================================

let promptModal = null;

// í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ì—´ê¸°
async function openPromptModal(agentName, displayName) {
    if (!promptModal) {
        promptModal = new bootstrap.Modal(document.getElementById('promptModal'));
    }

    document.getElementById('promptModalTitle').textContent = displayName + ' í”„ë¡¬í”„íŠ¸ ìˆ˜ì •';
    document.getElementById('promptAgentName').value = agentName;
    document.getElementById('promptContent').value = 'ë¡œë”© ì¤‘...';
    document.getElementById('promptCustomBadge').style.display = 'none';

    promptModal.show();

    // í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
    try {
        const response = await fetch(`/pipeline/prompt/${agentName}/`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await response.json();

        if (data.success) {
            document.getElementById('promptContent').value = data.content || '';
            if (data.is_custom) {
                document.getElementById('promptCustomBadge').style.display = 'inline';
            }
        } else {
            alert(data.message || 'í”„ë¡¬í”„íŠ¸ ë¡œë”© ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// í”„ë¡¬í”„íŠ¸ ì €ì¥
async function savePrompt() {
    const agentName = document.getElementById('promptAgentName').value;
    const content = document.getElementById('promptContent').value;

    if (!content.trim()) {
        alert('í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('content', content);

        const response = await fetch(`/pipeline/prompt/${agentName}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            alert('í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('promptCustomBadge').style.display = 'inline';
        } else {
            alert(data.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
async function resetPrompt() {
    if (!confirm('í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì €ì¥í•œ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;

    const agentName = document.getElementById('promptAgentName').value;

    try {
        const response = await fetch(`/pipeline/prompt/${agentName}/reset/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        const data = await response.json();

        if (data.success) {
            alert(data.message);
            document.getElementById('promptCustomBadge').style.display = 'none';
            // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            openPromptModal(agentName, document.getElementById('promptModalTitle').textContent.replace(' í”„ë¡¬í”„íŠ¸ ìˆ˜ì •', ''));
        } else {
            alert(data.message || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

// Markdown ë Œë”ë§
if (typeof marked !== 'undefined') {
    // ìë§‰ ë¶„ì„
    const transcriptData = document.getElementById('transcript-analysis-data');
    const transcriptMd = document.getElementById('transcript-analysis-md');
    if (transcriptData && transcriptMd) {
        transcriptMd.innerHTML = marked.parse(transcriptData.textContent);
    }

    // ëŒ“ê¸€ ë¶„ì„
    const commentData = document.getElementById('comment-analysis-data');
    const commentMd = document.getElementById('comment-analysis-md');
    if (commentData && commentMd) {
        commentMd.innerHTML = marked.parse(commentData.textContent);
    }

    // ëŒ€ë³¸ ê³„íš
    const planData = document.getElementById('script-plan-data');
    const planMd = document.getElementById('script-plan-md');
    if (planData && planMd) {
        planMd.innerHTML = marked.parse(planData.textContent);
    }

    // ë¦¬ì„œì¹˜ ê²°ê³¼
    const researchData = document.getElementById('research-result-data');
    const researchMd = document.getElementById('research-result-md');
    if (researchData && researchMd) {
        researchMd.innerHTML = marked.parse(researchData.textContent);
    }
}

// =============================================
// TTS ë³´ê¸°/ìˆ˜ì •
// =============================================

function toggleTts(sceneNumber) {
    const section = document.getElementById(`tts-${sceneNumber}`);
    if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
}

async function regenerateTts(sceneNumber) {
    if (!confirm('TTS í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìˆ«ìâ†’í•œê¸€ ë³€í™˜ ê·œì¹™ ì¬ì ìš©)')) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const formData = new FormData();
        formData.append('regenerate_tts', 'true');

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            // TTS í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const ttsText = document.querySelector(`#tts-${sceneNumber} .tts-text`);
            if (ttsText && data.narration_tts) {
                ttsText.textContent = data.narration_tts;
            }
            showToast('TTS í…ìŠ¤íŠ¸ê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert(data.message || 'TTS ì¬ìƒì„± ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

async function saveTtsText(sceneNumber) {
    const ttsText = document.querySelector(`#tts-${sceneNumber} .tts-text`);
    if (!ttsText) return;

    try {
        const formData = new FormData();
        formData.append('narration_tts', ttsText.textContent.trim());

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            showToast('TTS í…ìŠ¤íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert(data.message || 'TTS ì €ì¥ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    }
}

async function convertTtsAI(sceneNumber) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    const modelType = document.getElementById('tts-model-select')?.value || '2.5-flash';
    const formData = new FormData();
    formData.append('model_type', modelType);

    try {
        const response = await fetch(`{% url 'pipeline:scene_convert_tts' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData,
        });
        const data = await response.json();

        if (data.success) {
            const ttsText = document.querySelector(`#tts-${sceneNumber} .tts-text`);
            if (ttsText && data.narration_tts) {
                ttsText.textContent = data.narration_tts;
            }
            showToast('AI TTS ë³€í™˜ ì™„ë£Œ');
        } else {
            alert(data.message || 'TTS ë³€í™˜ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

async function convertAllTtsAI() {
    if (!confirm('ì „ì²´ ì”¬ì˜ TTS í…ìŠ¤íŠ¸ë¥¼ AIë¡œ ë³€í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë³€í™˜ ì¤‘...';

    const modelType = document.getElementById('tts-model-select').value;
    const formData = new FormData();
    formData.append('model_type', modelType);

    try {
        const response = await fetch("{% url 'pipeline:convert_all_tts' project.pk %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData,
        });

        // HTML ì‘ë‹µì¸ì§€ í™•ì¸ (ì—ëŸ¬ í˜ì´ì§€)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text.substring(0, 500));
            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${response.statusText}`);
        }

        const data = await response.json();

        if (data.success) {
            // ê° ì”¬ì˜ TTS í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            for (const result of data.results) {
                const ttsText = document.querySelector(`#tts-${result.scene} .tts-text`);
                if (ttsText) {
                    ttsText.textContent = result.tts;
                }
            }
            showToast(`TTS ë³€í™˜ ì™„ë£Œ: ${data.converted}ê°œ ì”¬`);
            if (data.errors > 0) {
                alert(`${data.errors}ê°œ ì”¬ ë³€í™˜ ì‹¤íŒ¨`);
            }
        } else {
            alert(data.message || 'TTS ë³€í™˜ ì‹¤íŒ¨');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}
</script>

<!-- ìë™ ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="autoPipelineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-lightning-fill"></i> ìë™ ìƒì„± ì„¤ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pipeline:auto_pipeline' project.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    {% if topic.video_id %}
                    <p class="text-muted small"><span class="badge bg-danger me-1"><i class="bi bi-youtube"></i></span>YouTube ìˆ˜ì§‘ â†’ ìë§‰ë¶„ì„ â†’ ëŒ“ê¸€ë¶„ì„ â†’ ëŒ€ë³¸ê³„íš â†’ ë¦¬ì„œì¹˜ â†’ ëŒ€ë³¸ â†’ ì”¬ë¶„í•  â†’ TTS â†’ ì´ë¯¸ì§€ â†’ ì˜ìƒìƒì„± â†’ ì˜ìƒì¡°ë¦½ê¹Œì§€ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ìë§‰ ë¶„ì„</label>
                        <select name="model_transcript_analyzer" class="form-select form-select-sm">
                            <option value="2.5-flash" selected>2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro">2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ëŒ“ê¸€ ë¶„ì„</label>
                        <select name="model_comment_analyzer" class="form-select form-select-sm">
                            <option value="2.5-flash" selected>2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro">2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ëŒ€ë³¸ ê³„íš</label>
                        <select name="model_script_planner" class="form-select form-select-sm">
                            <option value="2.5-flash" selected>2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro">2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>
                    {% else %}
                    <p class="text-muted small">ë¦¬ì„œì¹˜ â†’ ëŒ€ë³¸ â†’ ì”¬ë¶„í•  â†’ TTS â†’ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ â†’ ì´ë¯¸ì§€ â†’ ì˜ìƒìƒì„± â†’ ì˜ìƒì¡°ë¦½ê¹Œì§€ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
                    {% endif %}

                    <div class="mb-3">
                        <label class="form-label fw-bold">ë¦¬ì„œì¹˜</label>
                        <select name="model_researcher" class="form-select form-select-sm">
                            <option value="2.5-flash" selected>2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro">2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ëŒ€ë³¸ ì‘ì„±</label>
                        <select name="model_script_writer" class="form-select form-select-sm">
                            <option value="2.5-flash">2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro" selected>2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>

                    <p class="text-muted small mb-2"><i class="bi bi-info-circle"></i> ì”¬ ë¶„í• ì€ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘ (ëª¨ë¸ ë¶ˆí•„ìš”)</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</label>
                        <select name="model_image_prompter" class="form-select form-select-sm">
                            <option value="2.5-flash" selected>2.5 Flash ($0.30/$2.50)</option>
                            <option value="2.5-pro">2.5 Pro ($1.25/$10.00)</option>
                            <option value="flash">3 Flash ($0.50/$3.00)</option>
                            <option value="pro">3 Pro ($2.00/$12.00)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-lightning-fill"></i> ìë™ ìƒì„± ì‹œì‘
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
