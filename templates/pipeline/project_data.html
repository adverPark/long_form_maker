{% extends 'base.html' %}
{% load pipeline_tags %}

{% block title %}{{ project.name }} - 롱폼 영상 제작{% endblock %}

{% block extra_css %}
<style>
.step-section {
    border-left: 4px solid #dee2e6;
    margin-bottom: 1.5rem;
    background: #fff;
}
.step-section.has-data {
    border-left-color: #198754;
}
.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    cursor: pointer;
}
.step-header:hover {
    background: #e9ecef;
}
.step-body {
    padding: 1rem;
}
.char-counter {
    font-weight: bold;
}
.char-counter.good { color: #198754; }
.char-counter.warning { color: #ffc107; }
.char-counter.danger { color: #dc3545; }

/* 씬 카드 스타일 */
.scene-list {
    max-height: 70vh;
    overflow-y: auto;
}
.scene-card {
    display: grid;
    grid-template-columns: 50px 1fr 1fr 120px 120px 80px 100px;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    align-items: start;
}
.subtitle-status {
    font-size: 0.75em;
    text-align: center;
}
.subtitle-status.matched {
    color: #198754;
}
.subtitle-status.mismatch {
    color: #dc3545;
    font-weight: bold;
}
.subtitle-status.none {
    color: #6c757d;
}
.scene-audio {
    display: flex;
    align-items: center;
    gap: 4px;
}
.scene-audio audio {
    height: 30px;
    width: 100%;
}
.audio-loading {
    color: #6c757d;
    font-size: 0.8em;
}
.scene-card:hover {
    background: #f8f9fa;
}
.scene-number {
    font-size: 1.1em;
    color: #666;
}
.scene-narration {
    font-size: 0.95em;
    line-height: 1.5;
}
.narration-text {
    max-height: 80px;
    overflow: hidden;
}
.scene-prompt {
    font-size: 0.85em;
    color: #555;
    line-height: 1.4;
}
.prompt-text {
    max-height: 80px;
    overflow: hidden;
}
.prompt-empty {
    font-style: italic;
}
.scene-image {
    width: 120px;
    height: 68px;
    background: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.scene-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
}
.image-placeholder {
    font-size: 1.5em;
}
/* 영상 오버레이 */
.video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}
.video-overlay:hover {
    background: rgba(0,0,0,0.6);
}
.video-overlay i {
    color: white;
    font-size: 1.8em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
.scene-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.scene-actions .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
}

/* 인라인 편집 스타일 */
.editable-text {
    cursor: text;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}
.editable-text:hover {
    background: #f0f0f0;
}
.editable-text:focus {
    background: #fff;
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}
.editable-text.saving {
    background: #fff3cd;
}
.editable-text.saved {
    background: #d1e7dd;
}
.editable-text.error {
    background: #f8d7da;
}
.editable-text:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
}

/* 이미지 미리보기 모달 */
#imagePreviewModal .modal-body img {
    max-width: 100%;
    max-height: 80vh;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>{{ project.name }}</h2>
        <small class="text-muted">생성: {{ project.created_at|date:"Y-m-d H:i" }}</small>
    </div>
    <div>
        <a href="{% url 'pipeline:project_settings' project.pk %}" class="btn btn-outline-info btn-sm">
            <i class="bi bi-gear"></i> 설정
        </a>
        <a href="{% url 'pipeline:dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> 목록
        </a>
        <form method="post" action="{% url 'pipeline:project_delete' project.pk %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('정말 삭제하시겠습니까?')">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

<!-- 실행 중인 작업 배너 (여러 개 가능) -->
{% if running_executions %}
<div class="alert alert-warning mb-4">
    <div class="d-flex flex-wrap gap-3">
        {% for exec in running_executions %}
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-hourglass-split"></i>
            <strong>{{ exec.step.display_name }}</strong> ({{ exec.progress_percent }}%)
            <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="btn btn-warning btn-sm py-0">
                보기
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 1. 주제 -->
{% with exec=step_executions|dict_get:'topic_finder' %}
<div class="step-section {% if topic %}has-data{% endif %}" id="topic">
    <div class="step-header">
        <div>
            <strong>1. 주제</strong>
            {% if topic %}
            <span class="ms-2">{{ topic.title|truncatechars:50 }}</span>
            {% endif %}
        </div>
        <div class="d-flex gap-2 align-items-center">
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'topic_finder' %}" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" name="manual_input" class="form-control form-control-sm" style="width: 400px;"
                       value="{{ topic.title|default:'' }}" placeholder="주제를 입력하세요">
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </form>
            {% if topic %}
            <form method="post" action="{% url 'pipeline:auto_pipeline' project.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success"
                        onclick="return confirm('리서치~이미지까지 자동 생성합니다.\n계속하시겠습니까?')">
                    <i class="bi bi-lightning-fill"></i> 자동 생성
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 2. 리서치 -->
{% with exec=step_executions|dict_get:'researcher' %}
<div class="step-section {% if research %}has-data{% endif %}" id="research">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#research-body">
        <div>
            <strong>2. 리서치</strong>
            {% if exec.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 진행 중 ({{ exec.progress_percent }}%)
            </a>
            {% elif research %}
            <span class="badge bg-success ms-2">완료</span>
            <span class="ms-2 text-muted">
                인용구 {{ research.quotes|length }}개 | 숫자 {{ research.numbers|length }}개
            </span>
            {% endif %}
            {% if exec.total_tokens %}
            <small class="ms-2 text-primary">{{ exec.total_tokens }} 토큰 / ${{ exec.estimated_cost }}</small>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'researcher' %}" class="d-inline">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="flash">Flash</option>
                    <option value="pro">Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-search"></i> {% if research %}재실행{% else %}실행{% endif %}
                </button>
            </form>
        </div>
    </div>
    <div class="collapse {% if research %}show{% endif %}" id="research-body">
        <div class="step-body">
            {% if research %}
            {% if research.best_title.title %}
            <div class="alert alert-success py-2 mb-3">
                <strong>선정 제목:</strong> {{ research.best_title.title }}
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    <!-- 인용구 -->
                    {% if research.quotes %}
                    <details class="mb-3" open>
                        <summary><strong>인용구 ({{ research.quotes|length }}개)</strong></summary>
                        <ul class="mt-2 small">
                            {% for q in research.quotes %}
                            <li class="mb-2">"{{ q.quote }}" <br><small class="text-muted">- {{ q.source }}</small></li>
                            {% endfor %}
                        </ul>
                    </details>
                    {% endif %}

                    <!-- 숫자/통계 -->
                    {% if research.numbers %}
                    <details class="mb-3" open>
                        <summary><strong>숫자/통계 ({{ research.numbers|length }}개)</strong></summary>
                        <ul class="mt-2 small">
                            {% for n in research.numbers %}
                            <li class="mb-1"><strong>{{ n.number }}</strong> - {{ n.context }}</li>
                            {% endfor %}
                        </ul>
                    </details>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <!-- 인물 사례 -->
                    {% if research.person_stories %}
                    <details class="mb-3">
                        <summary><strong>인물 사례 ({{ research.person_stories|length }}개)</strong></summary>
                        <div class="mt-2 small">
                            {% for p in research.person_stories %}
                            <div class="border-start border-2 border-primary ps-2 mb-2">
                                <strong>{{ p.name }}</strong><br>
                                {{ p.past|default:'' }} → {{ p.present|default:'' }}
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% endif %}

                    <!-- 역설 -->
                    {% if research.paradox.common_belief %}
                    <details class="mb-3">
                        <summary><strong>역설/반전</strong></summary>
                        <div class="mt-2 small bg-light p-2 rounded">
                            <strong>통념:</strong> {{ research.paradox.common_belief }}<br>
                            <strong>현실:</strong> {{ research.paradox.reality }}
                        </div>
                    </details>
                    {% endif %}
                </div>
            </div>

            <!-- 기사별 요약 -->
            {% if research.article_summaries %}
            <details class="mb-3">
                <summary><strong>검색 결과 상세 ({{ research.article_summaries|length }}개)</strong></summary>
                <div class="mt-2">
                    {% for article in research.article_summaries %}
                    <div class="card mb-2">
                        <div class="card-header py-1">
                            <small class="text-primary"><i class="bi bi-search"></i> {{ article.query }}</small>
                        </div>
                        <div class="card-body py-2">
                            <div style="font-size: 0.8em; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ article.summary }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {% else %}
            <p class="text-muted mb-0">리서치를 실행하세요.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 3. 대본 -->
{% with exec=step_executions|dict_get:'script_writer' %}
<div class="step-section {% if draft %}has-data{% endif %}" id="draft">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#draft-body">
        <div>
            <strong>3. 대본</strong>
            {% if exec.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 진행 중 ({{ exec.progress_percent }}%)
            </a>
            {% elif draft %}
            <span class="badge bg-{% if draft.char_count >= 7500 and draft.char_count <= 8500 %}success{% elif draft.char_count >= 7000 %}warning{% else %}danger{% endif %} ms-2">
                {{ draft.char_count }}자
            </span>
            <span class="ms-2 text-muted">{{ draft.title|truncatechars:40 }}</span>
            {% endif %}
            {% if exec.total_tokens %}
            <small class="ms-2 text-primary">{{ exec.total_tokens }} 토큰 / ${{ exec.estimated_cost }}</small>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'script_writer' %}" class="d-inline">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="flash">Flash</option>
                    <option value="pro" selected>Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> {% if draft %}재생성{% else %}생성{% endif %}
                </button>
            </form>
        </div>
    </div>
    <div class="collapse {% if draft %}show{% endif %}" id="draft-body">
        <div class="step-body">
            <div class="mb-2 d-flex justify-content-between align-items-center">
                <div>
                    <span class="char-counter {% if draft.char_count >= 7500 and draft.char_count <= 8500 %}good{% elif draft.char_count >= 7000 %}warning{% else %}danger{% endif %}" id="draft-char-count">
                        {{ draft.char_count|default:0 }}자
                    </span>
                    <small class="text-muted">/ 목표 7,500~8,500자</small>
                </div>
                <button class="btn btn-sm btn-success" id="save-draft-btn" onclick="saveDraft()" disabled>
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
            <input type="text" class="form-control form-control-sm mb-2" id="draft-title"
                   value="{{ draft.title|default:'' }}" placeholder="제목" onchange="enableSave()">
            <textarea class="form-control" id="draft-content" rows="20"
                      style="font-family: monospace; font-size: 0.9em; line-height: 1.8;"
                      placeholder="대본 내용..." oninput="updateCharCount()">{{ draft.content|default:'' }}</textarea>
        </div>
    </div>
</div>
{% endwith %}

<!-- 4. 씬 분할 + 씬 목록 -->
{% with exec_planner=step_executions|dict_get:'scene_planner' exec_prompter=step_executions|dict_get:'image_prompter' exec_generator=step_executions|dict_get:'scene_generator' exec_tts=step_executions|dict_get:'tts_generator' %}
<div class="step-section {% if scenes.count > 0 %}has-data{% endif %}" id="scenes">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#scenes-body">
        <div>
            <strong>4. 씬 관리</strong>
            {% if scenes.count > 0 %}
            <span class="badge bg-success ms-2">{{ scenes.count }}개 씬</span>
            {% endif %}
            <!-- 진행 중인 작업 표시 -->
            {% if exec_planner.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_planner.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 씬분할 {{ exec_planner.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_prompter.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_prompter.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 프롬프트 {{ exec_prompter.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_generator.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_generator.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 이미지 {{ exec_generator.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_tts.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_tts.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> TTS {{ exec_tts.progress_percent }}%
            </a>
            {% endif %}
            <!-- 토큰 사용량 표시 -->
            {% if exec_planner.total_tokens or exec_prompter.total_tokens or exec_generator.total_tokens or exec_tts.total_tokens %}
            <small class="ms-2 text-primary">
                {% if exec_planner.total_tokens %}씬: {{ exec_planner.total_tokens|floatformat:0 }}t (${{ exec_planner.estimated_cost }}){% endif %}
                {% if exec_prompter.total_tokens %} | 프롬프트: {{ exec_prompter.total_tokens|floatformat:0 }}t (${{ exec_prompter.estimated_cost }}){% endif %}
                {% if exec_generator.total_tokens %} | 이미지: {{ exec_generator.total_tokens|floatformat:0 }}t (${{ exec_generator.estimated_cost }}){% endif %}
                {% if exec_tts.total_tokens %} | TTS: {{ exec_tts.total_tokens|floatformat:0 }}t{% endif %}
            </small>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <!-- 씬 분할 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'scene_planner' %}" class="d-inline">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                    <option value="flash">Flash</option>
                    <option value="pro">Pro</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-grid-3x3"></i> 씬분할
                </button>
            </form>
            <!-- 프롬프트 생성 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'image_prompter' %}" class="d-inline ms-1">
                {% csrf_token %}
                <label class="form-check form-check-inline mb-0" style="font-size: 0.85em;" title="Flash 모델용: 이미지에 텍스트 넣지 않음">
                    <input type="checkbox" name="no_text" value="1" class="form-check-input">
                    <span class="form-check-label">한글금지</span>
                </label>
                <button type="submit" class="btn btn-sm btn-outline-info" {% if scenes.count == 0 %}disabled{% endif %}>
                    <i class="bi bi-chat-text"></i> 프롬프트
                </button>
            </form>
            <!-- 전체 이미지 생성 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'scene_generator' %}" class="d-inline ms-1">
                {% csrf_token %}
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;" {% if scenes.count == 0 %}disabled{% endif %}>
                    <option value="pro">Pro</option>
                    <option value="flash">Flash</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-success" {% if scenes.count == 0 %}disabled{% endif %}>
                    <i class="bi bi-images"></i> 이미지
                </button>
            </form>
            <!-- 전체 TTS 생성 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'tts_generator' %}" class="d-inline ms-1">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-info" {% if scenes.count == 0 %}disabled{% endif %}>
                    <i class="bi bi-mic"></i> TTS
                </button>
            </form>
            <!-- 이미지 + TTS 동시 실행 -->
            <form method="post" action="{% url 'pipeline:step_execute_parallel' project.pk %}" class="d-inline ms-2">
                {% csrf_token %}
                <input type="hidden" name="steps" value="scene_generator">
                <input type="hidden" name="steps" value="tts_generator">
                <select name="model_type" class="form-select form-select-sm d-inline-block" style="width: auto;" {% if scenes.count == 0 %}disabled{% endif %}>
                    <option value="pro">Pro</option>
                    <option value="flash">Flash</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary" {% if scenes.count == 0 %}disabled{% endif %}>
                    <i class="bi bi-lightning-fill"></i> 이미지+TTS
                </button>
            </form>
        </div>
    </div>
    <div class="collapse {% if scenes.count > 0 %}show{% endif %}" id="scenes-body">
        <div class="step-body p-0">
            {% if scenes.count > 0 %}
            <!-- 전체 삭제 버튼 -->
            <div class="d-flex gap-2 p-2 border-bottom bg-light">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAllImages()">
                    <i class="bi bi-trash"></i> 이미지 전체 삭제
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAllAudio()">
                    <i class="bi bi-trash"></i> 오디오 전체 삭제
                </button>
            </div>
            <!-- 씬 헤더 -->
            <div class="scene-card" style="background: #f8f9fa; font-weight: bold; font-size: 0.85em; padding: 8px 16px;">
                <div>#</div>
                <div>나레이션</div>
                <div>이미지 프롬프트</div>
                <div>이미지</div>
                <div>오디오</div>
                <div>자막</div>
                <div>액션</div>
            </div>
            <!-- 씬 카드 목록 -->
            <div class="scene-list">
                {% for scene in scenes %}
                <div class="scene-card" id="scene-{{ scene.scene_number }}">
                    <div class="scene-number">
                        <strong>{{ scene.scene_number }}.</strong>
                        <label class="mb-0" style="cursor: pointer;" title="캐릭터 등장 토글">
                            <input type="checkbox" class="form-check-input"
                                   {% if scene.has_character %}checked{% endif %}
                                   onchange="toggleCharacter({{ scene.scene_number }}, this.checked)">
                        </label>
                    </div>
                    <div class="scene-narration">
                        <div class="narration-text editable-text"
                             contenteditable="true"
                             data-scene="{{ scene.scene_number }}"
                             data-field="narration"
                             onblur="saveField(this)"
                             onkeydown="handleEditKey(event, this)">{{ scene.narration }}</div>
                    </div>
                    <div class="scene-prompt">
                        <div class="prompt-text editable-text"
                             contenteditable="true"
                             data-scene="{{ scene.scene_number }}"
                             data-field="image_prompt"
                             onblur="saveField(this)"
                             onkeydown="handleEditKey(event, this)"
                             {% if not scene.image_prompt %}data-placeholder="(클릭하여 프롬프트 입력)"{% endif %}>{{ scene.image_prompt|default:"" }}</div>
                    </div>
                    <div class="scene-image">
                        {% if scene.image %}
                        <img src="{{ scene.image.url }}" alt="씬 {{ scene.scene_number }}" class="scene-thumbnail" onclick="previewImage('{{ scene.image.url }}')">
                        {% if scene.video %}
                        <div class="video-overlay" onclick="event.stopPropagation(); previewVideo('{{ scene.video.url }}', {{ scene.scene_number }})" title="인트로 영상 재생">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="image-placeholder">
                            <i class="bi bi-image text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="scene-audio" id="audio-container-{{ scene.scene_number }}">
                        {% if scene.audio %}
                        <audio controls preload="none">
                            <source src="{{ scene.audio.url }}" type="audio/wav">
                        </audio>
                        {% else %}
                        <span class="text-muted" style="font-size: 0.8em;"><i class="bi bi-mic-mute"></i> 없음</span>
                        {% endif %}
                    </div>
                    <div class="subtitle-status {{ scene.subtitle_status }}" id="subtitle-status-{{ scene.scene_number }}">
                        {% if scene.subtitle_status == 'matched' %}
                        <i class="bi bi-check-circle-fill text-success"></i><br>
                        {{ scene.subtitle_word_count }}자
                        {% elif scene.subtitle_status == 'mismatch' %}
                        <i class="bi bi-exclamation-triangle-fill text-warning"></i><br>
                        {{ scene.subtitle_word_count }}/{{ scene.narration_word_count }}
                        {% elif scene.subtitle_status == 'incomplete' %}
                        <i class="bi bi-x-circle-fill text-danger"></i><br>
                        {{ scene.subtitle_word_count }}/{{ scene.narration_word_count }} 불완전
                        {% elif scene.audio %}
                        <i class="bi bi-question-circle text-warning"></i><br>
                        미검증
                        {% else %}
                        <i class="bi bi-dash-circle text-muted"></i><br>
                        -
                        {% endif %}
                    </div>
                    <div class="scene-actions">
                        <div class="btn-group btn-group-sm">
                            <button class="btn {% if scene.image %}btn-outline-warning{% else %}btn-outline-primary{% endif %}"
                                    onclick="generateSceneImage({{ scene.scene_number }}, 'pro')"
                                    title="Pro 모델로 생성">
                                <i class="bi bi-image"></i>
                            </button>
                            <button class="btn {% if scene.image %}btn-outline-warning{% else %}btn-outline-primary{% endif %} dropdown-toggle dropdown-toggle-split"
                                    data-bs-toggle="dropdown" title="모델 선택">
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'pro'); return false;">Pro (고품질)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateSceneImage({{ scene.scene_number }}, 'flash'); return false;">Flash (빠름)</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-sm {% if scene.audio %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                                onclick="generateSceneTTS({{ scene.scene_number }})"
                                title="{% if scene.audio %}TTS 재생성{% else %}TTS 생성{% endif %}">
                            <i class="bi bi-mic"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger"
                                onclick="deleteScene({{ scene.scene_number }})"
                                title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-grid-3x3-gap display-4"></i>
                <p class="mt-2">대본을 기반으로 씬을 분할하세요.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endwith %}

<!-- 5. 영상 제작 -->
{% with exec_video=step_executions|dict_get:'video_generator' exec_compose=step_executions|dict_get:'video_composer' exec_thumb=step_executions|dict_get:'thumbnail_generator' %}
<div class="step-section" id="video">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#video-body">
        <div>
            <strong>5. 영상 제작</strong>
            {% if project.final_video %}
            <span class="badge bg-success ms-2">완료</span>
            {% endif %}
            <!-- 진행 중인 작업 표시 -->
            {% if exec_video.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_video.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 인트로 {{ exec_video.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_compose.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_compose.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 편집 {{ exec_compose.progress_percent }}%
            </a>
            {% endif %}
            {% if exec_thumb.status == 'running' %}
            <a href="{% url 'pipeline:step_progress' project.pk exec_thumb.pk %}" class="badge bg-warning text-dark ms-2" onclick="event.stopPropagation();">
                <i class="bi bi-hourglass-split"></i> 썸네일 {{ exec_thumb.progress_percent }}%
            </a>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();">
            <!-- 앞 4씬 동영상 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'video_generator' %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-film"></i> 인트로영상
                </button>
            </form>
            <!-- 최종 편집 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'video_composer' %}" class="d-inline ms-1">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-camera-video"></i> 최종편집
                </button>
            </form>
            <!-- 썸네일 -->
            <form method="post" action="{% url 'pipeline:step_execute' project.pk 'thumbnail_generator' %}" class="d-inline ms-1">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-card-image"></i> 썸네일
                </button>
            </form>
            <!-- 임시 파일 삭제 -->
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFinalVideo()" title="임시 클립, ASS 자막 등 삭제">
                <i class="bi bi-trash"></i> 초기화
            </button>
        </div>
    </div>
    <div class="collapse {% if project.final_video %}show{% endif %}" id="video-body">
        <div class="step-body">
            <div class="row">
                {% if project.final_video %}
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">최종 영상</h6>
                        <a href="{{ project.final_video.url }}" download="{{ project.name }}_final.mp4" class="btn btn-sm btn-success" title="영상 다운로드">
                            <i class="bi bi-download"></i> 다운로드
                        </a>
                    </div>
                    <video controls class="w-100" style="max-height: 400px;">
                        <source src="{{ project.final_video.url }}" type="video/mp4">
                    </video>
                </div>
                {% endif %}
                {% if project.thumbnail %}
                <div class="col-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">썸네일</h6>
                        <a href="{{ project.thumbnail.url }}" download="{{ project.name }}_thumbnail.png" class="btn btn-sm btn-outline-success" title="썸네일 다운로드">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                    <img src="{{ project.thumbnail.url }}" class="img-fluid">
                </div>
                {% endif %}
                {% if project.full_subtitles %}
                <div class="col-12 mt-3">
                    <a href="{{ project.full_subtitles.url }}" download="{{ project.name }}_subtitles.srt" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-file-text"></i> 전체 자막 다운로드 (SRT)
                    </a>
                </div>
                {% endif %}
                {% if not project.final_video and not project.thumbnail %}
                <div class="col-12 text-muted">
                    씬 이미지 생성 후 영상을 제작하세요.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endwith %}

<!-- 6. 업로드 정보 -->
<div class="step-section" id="upload">
    <div class="step-header" data-bs-toggle="collapse" data-bs-target="#upload-body">
        <div>
            <strong>6. 업로드 정보</strong>
            {% if project.upload_info %}
            <span class="badge bg-success ms-2">설정됨</span>
            {% endif %}
        </div>
        <div onclick="event.stopPropagation();" class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" id="upload-model-select" style="width: auto;">
                <option value="flash">Flash (빠름)</option>
                <option value="pro">Pro (고품질)</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="generateUploadInfo()">
                <i class="bi bi-magic"></i> 자동 생성
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="saveUploadInfo()">
                <i class="bi bi-save"></i> 저장
            </button>
            <span id="upload-token-info" class="small text-muted"></span>
        </div>
    </div>
    <div class="collapse" id="upload-body">
        <div class="step-body">
            <div class="row">
                <!-- 왼쪽: 입력 폼 -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">제목 (70자 이내)</label>
                        <input type="text" class="form-control" id="upload-title" maxlength="100"
                            value="{{ project.upload_info.title|default:'' }}"
                            placeholder="영상 제목">
                        <small class="text-muted">현재: <span id="title-count">0</span>/70자</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">설명</label>
                        <textarea class="form-control" id="upload-description" rows="4"
                            placeholder="영상 설명 (타임라인, 해시태그 자동 추가됨)">{{ project.upload_info.description|default:'' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">태그 (쉼표로 구분)</label>
                        <input type="text" class="form-control" id="upload-tags"
                            value="{{ project.upload_info.get_tags_string|default:'' }}"
                            placeholder="경제, 자영업, 재테크, ...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">타임라인</label>
                        <div class="bg-light p-2 rounded small" id="upload-timeline">
                            {% if project.upload_info and project.upload_info.timeline %}
                            {% for item in project.upload_info.timeline %}
                            {{ item.time }} {{ item.title }}<br>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">"자동 생성" 버튼을 누르면 생성됩니다.</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 오른쪽: 썸네일 -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">썸네일 스타일</label>
                        <select class="form-select" id="thumbnail-style-select">
                            <option value="">스타일 선택 안함</option>
                            {% for style in thumbnail_styles %}
                            <option value="{{ style.pk }}" {% if project.thumbnail_style_id == style.pk %}selected{% endif %}>
                                {{ style.name }} ({{ style.get_style_type_display }}){% if style.is_default %} - 기본{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">예시 이미지를 참고하여 생성합니다</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">썸네일 프롬프트</label>
                        <textarea class="form-control" id="thumbnail-prompt" rows="5"
                            placeholder="썸네일 이미지 생성 프롬프트">{{ project.upload_info.thumbnail_prompt|default:'' }}</textarea>
                    </div>
                    <button class="btn btn-warning mb-3" onclick="generateThumbnail()">
                        <i class="bi bi-image"></i> 썸네일 생성
                    </button>
                    <div id="thumbnail-preview">
                        {% if project.thumbnail %}
                        <img src="{{ project.thumbnail.url }}" class="img-fluid rounded shadow">
                        <div class="mt-2">
                            <a href="{{ project.thumbnail.url }}" download class="btn btn-sm btn-outline-success">
                                <i class="bi bi-download"></i> 다운로드
                            </a>
                        </div>
                        {% else %}
                        <div class="bg-light p-5 text-center rounded">
                            <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">썸네일을 생성하세요</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 전체 설명 미리보기 -->
            <div class="mt-4">
                <label class="form-label fw-bold">전체 설명 미리보기 (복사용)</label>
                <textarea class="form-control bg-light" id="full-description" rows="10" readonly
                    onclick="this.select()">{{ project.upload_info.get_full_description|default:'' }}</textarea>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyFullDescription()">
                    <i class="bi bi-clipboard"></i> 복사
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 토큰 사용량 요약 -->
{% if total_tokens > 0 %}
<div class="card mt-4 border-info">
    <div class="card-header bg-info text-white py-2">
        <i class="bi bi-graph-up"></i> <strong>토큰 사용량 요약</strong>
    </div>
    <div class="card-body py-2">
        <div class="row small">
            {% for step_name, exec in step_executions.items %}
            {% if exec.total_tokens > 0 %}
            <div class="col-md-4 col-lg-3 mb-2">
                <span class="text-muted">{{ exec.step.display_name }}:</span><br>
                <strong>{{ exec.total_tokens|floatformat:0 }}</strong> 토큰
                <span class="text-success">(${{ exec.estimated_cost }})</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-calculator"></i>
                <strong>총 토큰: {{ total_tokens|floatformat:0 }}</strong>
            </span>
            <span class="text-success fs-5">
                <strong>총 비용: ${{ total_cost }}</strong>
            </span>
        </div>
    </div>
</div>
{% endif %}

<!-- 이미지 미리보기 모달 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">이미지 미리보기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImg" src="" alt="미리보기">
            </div>
        </div>
    </div>
</div>

<!-- 영상 미리보기 모달 -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">씬 <span id="videoSceneNum"></span> 인트로 영상</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <video id="previewVideo" controls class="w-100" style="max-height: 70vh;">
                    <source src="" type="video/mp4">
                </video>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function updateCharCount() {
    const content = document.getElementById('draft-content');
    if (!content) return;

    const count = content.value.length;
    const counter = document.getElementById('draft-char-count');
    counter.textContent = count + '자';

    counter.classList.remove('good', 'warning', 'danger');
    if (count >= 7500 && count <= 8500) {
        counter.classList.add('good');
    } else if (count >= 7000) {
        counter.classList.add('warning');
    } else {
        counter.classList.add('danger');
    }

    enableSave();
}

function enableSave() {
    const btn = document.getElementById('save-draft-btn');
    if (btn) btn.disabled = false;
}

async function saveDraft() {
    const btn = document.getElementById('save-draft-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass"></i> 저장 중...';

    const title = document.getElementById('draft-title').value;
    const content = document.getElementById('draft-content').value;

    try {
        const formData = new FormData();
        formData.append('title', title);
        formData.append('content', content);

        const response = await fetch('{% url "pipeline:draft_update" project.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            btn.innerHTML = '<i class="bi bi-check-lg"></i> 저장됨';
            document.getElementById('draft-char-count').textContent = data.char_count + '자';
            setTimeout(() => {
                btn.innerHTML = '<i class="bi bi-check-lg"></i> 저장';
            }, 2000);
        } else {
            alert(data.message || '저장 실패');
            btn.innerHTML = '<i class="bi bi-check-lg"></i> 저장';
            btn.disabled = false;
        }
    } catch (error) {
        alert('오류: ' + error.message);
        btn.innerHTML = '<i class="bi bi-check-lg"></i> 저장';
        btn.disabled = false;
    }
}

// 이미지 미리보기
function previewImage(url) {
    document.getElementById('previewImg').src = url;
    new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
}

// 영상 미리보기
function previewVideo(url, sceneNumber) {
    const video = document.getElementById('previewVideo');
    video.querySelector('source').src = url;
    video.load();
    document.getElementById('videoSceneNum').textContent = sceneNumber;

    const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
    modal.show();

    // 모달 닫힐 때 영상 정지
    document.getElementById('videoPreviewModal').addEventListener('hidden.bs.modal', function() {
        video.pause();
    }, { once: true });
}

// 씬 이미지 생성 (개별)
async function generateSceneImage(sceneNumber, modelType = 'pro') {
    const modelName = modelType === 'flash' ? 'Flash' : 'Pro';
    if (!confirm(`씬 ${sceneNumber}의 이미지를 ${modelName} 모델로 생성하시겠습니까?`)) return;

    const btn = event.target.closest('.btn-group') || event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    // btn-group이면 모든 버튼 비활성화
    const buttons = btn.querySelectorAll ? btn.querySelectorAll('button') : [btn];
    buttons.forEach(b => b.disabled = true);

    try {
        const formData = new FormData();
        formData.append('model_type', modelType);

        const response = await fetch(`{% url 'pipeline:scene_generate_image' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // 이미지 영역 업데이트
            const sceneCard = document.getElementById(`scene-${sceneNumber}`);
            const imageDiv = sceneCard.querySelector('.scene-image');
            imageDiv.innerHTML = `<img src="${data.image_url}" alt="씬 ${sceneNumber}" class="scene-thumbnail" onclick="previewImage('${data.image_url}')">`;
            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        } else {
            alert(data.message || '이미지 생성 실패');
            btn.innerHTML = originalHtml;
        }
    } catch (error) {
        alert('오류: ' + error.message);
        btn.innerHTML = originalHtml;
    }
    buttons.forEach(b => b.disabled = false);
}

// 씬 TTS 생성 (개별)
async function generateSceneTTS(sceneNumber) {
    if (!confirm(`씬 ${sceneNumber}의 TTS를 생성하시겠습니까?`)) return;

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;

    try {
        const response = await fetch(`{% url 'pipeline:scene_generate_tts' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const data = await response.json();

        if (data.success) {
            // 오디오 영역 업데이트
            const audioContainer = document.getElementById(`audio-container-${sceneNumber}`);
            audioContainer.innerHTML = `<audio controls preload="none"><source src="${data.audio_url}" type="audio/wav"></audio>`;

            // 자막 상태 업데이트
            const subtitleStatus = document.getElementById(`subtitle-status-${sceneNumber}`);
            if (subtitleStatus) {
                subtitleStatus.className = `subtitle-status ${data.subtitle_status}`;
                if (data.subtitle_status === 'matched') {
                    subtitleStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i><br>${data.subtitle_word_count}자`;
                } else if (data.subtitle_status === 'mismatch') {
                    subtitleStatus.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-warning"></i><br>${data.subtitle_word_count}/${data.narration_word_count}`;
                } else if (data.subtitle_status === 'incomplete') {
                    subtitleStatus.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i><br>${data.subtitle_word_count}/${data.narration_word_count} 불완전`;
                } else {
                    subtitleStatus.innerHTML = `<i class="bi bi-dash-circle text-muted"></i><br>-`;
                }
            }

            btn.innerHTML = '<i class="bi bi-check-lg"></i>';
        } else {
            alert(data.message || 'TTS 생성 실패');
            btn.innerHTML = originalHtml;
        }
    } catch (error) {
        alert('오류: ' + error.message);
        btn.innerHTML = originalHtml;
    }
    btn.disabled = false;
}

// 인라인 편집 - 필드 저장
let saveTimeout = null;
async function saveField(element) {
    const sceneNumber = element.dataset.scene;
    const field = element.dataset.field;
    const value = element.innerText.trim();

    // 저장 중 표시
    element.classList.remove('saved', 'error');
    element.classList.add('saving');

    try {
        const formData = new FormData();
        formData.append(field, value);

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });

        const data = await response.json();
        element.classList.remove('saving');

        if (data.success) {
            element.classList.add('saved');
            setTimeout(() => element.classList.remove('saved'), 1500);
        } else {
            element.classList.add('error');
            console.error('저장 실패:', data.message);
        }
    } catch (error) {
        element.classList.remove('saving');
        element.classList.add('error');
        console.error('오류:', error.message);
    }
}

// 키 입력 처리 (Enter로 저장, Shift+Enter로 줄바꿈)
function handleEditKey(event, element) {
    if (event.key === 'Escape') {
        element.blur();
    }
}

// 캐릭터 등장 토글
async function toggleCharacter(sceneNumber, hasCharacter) {
    try {
        const formData = new FormData();
        formData.append('has_character', hasCharacter);

        const response = await fetch(`{% url 'pipeline:scene_edit' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        });

        const data = await response.json();
        if (!data.success) {
            alert(data.message || '저장 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    }
}

// 씬 삭제
async function deleteScene(sceneNumber) {
    if (!confirm(`씬 ${sceneNumber}을(를) 삭제하시겠습니까?\n삭제 후 씬 번호가 재정렬됩니다.`)) return;

    try {
        const response = await fetch(`{% url 'pipeline:scene_delete' project.pk 0 %}`.replace('/0/', `/${sceneNumber}/`), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '삭제 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    }
}

// 이미지 전체 삭제
async function deleteAllImages() {
    if (!confirm('모든 씬의 이미지를 삭제하시겠습니까?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_images" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || '삭제 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    }
}

// 오디오 전체 삭제
async function deleteAllAudio() {
    if (!confirm('모든 씬의 오디오와 자막을 삭제하시겠습니까?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_all_audio" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || '삭제 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    }
}

// 영상 제작 초기화 (임시 파일 삭제, 씬 영상은 유지)
async function deleteFinalVideo() {
    if (!confirm('영상 편집 파일을 삭제합니다:\n\n• 최종 영상\n• 임시 클립\n• ASS 자막\n• 전체 자막\n\n※ 씬 영상(인트로)은 유지됩니다.\n\n삭제 후 "최종편집"을 다시 실행하세요.\n\n계속하시겠습니까?')) return;

    try {
        const response = await fetch('{% url "pipeline:delete_final_video" project.pk %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || '삭제 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    }
}

// =============================================
// 업로드 정보 관련
// =============================================

// 제목 글자수 표시
const uploadTitleInput = document.getElementById('upload-title');
const titleCountSpan = document.getElementById('title-count');

if (uploadTitleInput) {
    uploadTitleInput.addEventListener('input', function() {
        titleCountSpan.textContent = this.value.length;
        if (this.value.length > 70) {
            titleCountSpan.classList.add('text-danger');
        } else {
            titleCountSpan.classList.remove('text-danger');
        }
    });
    // 초기값 표시
    titleCountSpan.textContent = uploadTitleInput.value.length;
}

// 업로드 정보 자동 생성
async function generateUploadInfo() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 생성 중...';

    // 모델 선택
    const modelType = document.getElementById('upload-model-select').value;
    const formData = new FormData();
    formData.append('model_type', modelType);

    try {
        const response = await fetch("{% url 'pipeline:generate_upload_info' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            document.getElementById('upload-title').value = data.title || '';
            document.getElementById('upload-description').value = data.description || '';
            document.getElementById('upload-tags').value = data.tags ? data.tags.join(', ') : '';
            document.getElementById('thumbnail-prompt').value = data.thumbnail_prompt || '';
            document.getElementById('full-description').value = data.full_description || '';

            // 타임라인 표시
            const timelineDiv = document.getElementById('upload-timeline');
            if (data.timeline && data.timeline.length > 0) {
                timelineDiv.innerHTML = data.timeline.map(t => `${t.time} ${t.title}`).join('<br>');
            }

            // 제목 글자수 업데이트
            titleCountSpan.textContent = (data.title || '').length;

            // 토큰 정보 표시
            const tokenInfoSpan = document.getElementById('upload-token-info');
            if (data.token_info && data.token_info.total > 0) {
                tokenInfoSpan.innerHTML = `<i class="bi bi-coin"></i> ${data.token_info.total.toLocaleString()} 토큰 ($${data.token_info.cost})`;
            }

            alert('업로드 정보가 생성되었습니다.');
        } else {
            alert(data.message || '생성 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// 업로드 정보 저장
async function saveUploadInfo() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    const formData = new FormData();
    formData.append('title', document.getElementById('upload-title').value);
    formData.append('description', document.getElementById('upload-description').value);
    formData.append('tags', document.getElementById('upload-tags').value);
    formData.append('thumbnail_prompt', document.getElementById('thumbnail-prompt').value);

    try {
        const response = await fetch("{% url 'pipeline:upload_info' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            alert(data.message);
        } else {
            alert(data.message || '저장 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// 썸네일 생성
async function generateThumbnail() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 생성 중...';

    const prompt = document.getElementById('thumbnail-prompt').value;
    if (!prompt.trim()) {
        alert('썸네일 프롬프트를 입력해주세요.');
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }

    const formData = new FormData();
    formData.append('prompt', prompt);
    // 선택된 썸네일 스타일 ID 추가
    const styleSelect = document.getElementById('thumbnail-style-select');
    if (styleSelect && styleSelect.value) {
        formData.append('style_id', styleSelect.value);
    }

    try {
        const response = await fetch("{% url 'pipeline:generate_thumbnail' project.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            const previewDiv = document.getElementById('thumbnail-preview');
            previewDiv.innerHTML = `
                <img src="${data.thumbnail_url}" class="img-fluid rounded shadow">
                <div class="mt-2">
                    <a href="${data.thumbnail_url}" download class="btn btn-sm btn-outline-success">
                        <i class="bi bi-download"></i> 다운로드
                    </a>
                </div>
            `;
        } else {
            alert(data.message || '썸네일 생성 실패');
        }
    } catch (error) {
        alert('오류: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// 전체 설명 복사
function copyFullDescription() {
    const textarea = document.getElementById('full-description');
    textarea.select();
    document.execCommand('copy');
    alert('복사되었습니다!');
}

// 초기 글자수 표시
document.addEventListener('DOMContentLoaded', updateCharCount);
</script>
{% endblock %}
