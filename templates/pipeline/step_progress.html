{% extends 'base.html' %}

{% block title %}ì§„í–‰ ì¤‘ - {{ execution.step.display_name }}{% endblock %}

{% block extra_css %}
<style>
.log-container {
    max-height: 400px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85em;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 8px;
}
.log-entry {
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #333;
}
.log-time {
    color: #888;
    margin-right: 10px;
}
.log-type-info { color: #4fc1ff; }
.log-type-search { color: #dcdcaa; }
.log-type-result { color: #4ec9b0; }
.log-type-error { color: #f14c4c; }
.log-type-warning { color: #cca700; }
.log-data {
    margin-top: 5px;
    padding-left: 20px;
    color: #9cdcfe;
    font-size: 0.9em;
}
.log-source {
    color: #ce9178;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'pipeline:dashboard' %}">ëŒ€ì‹œë³´ë“œ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'pipeline:project_data' project.pk %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">{{ execution.step.display_name }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="mb-3">{{ execution.step.display_name }}</h3>

                <!-- ëª¨ë¸ ì •ë³´ -->
                <div class="mb-3">
                    <span class="badge bg-secondary">
                        <i class="bi bi-cpu"></i>
                        {% if execution.step.name == 'video_generator' %}
                            Replicate seedance-1-pro
                        {% elif execution.step.name == 'tts_generator' %}
                            Fish Speech
                        {% elif execution.step.name == 'video_composer' %}
                            FFmpeg
                        {% elif execution.step.name == 'scene_generator' %}
                            {{ project.image_model|default:'gemini-3-pro' }}
                        {% else %}
                            {% if execution.model_type == '2.5-flash' %}Gemini 2.5 Flash
                            {% elif execution.model_type == '2.5-pro' %}Gemini 2.5 Pro
                            {% elif execution.model_type == 'pro' %}Gemini 3 Pro
                            {% else %}Gemini 3 Flash{% endif %}
                        {% endif %}
                    </span>
                </div>

                <!-- í† í° ì‚¬ìš©ëŸ‰ -->
                <div class="mb-3 p-3 bg-light rounded" id="token-info">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>ì…ë ¥ í† í°</span>
                        <span id="input-tokens">{{ execution.input_tokens|default:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>ì¶œë ¥ í† í°</span>
                        <span id="output-tokens">{{ execution.output_tokens|default:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between small fw-bold">
                        <span>ì´ í† í°</span>
                        <span id="total-tokens">{{ execution.total_tokens|default:0 }}</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">ì˜ˆìƒ ë¹„ìš©</span>
                        <span id="estimated-cost" class="fw-bold text-primary">$<span id="cost-value">{{ execution.estimated_cost|default:0 }}</span></span>
                    </div>
                </div>

                <!-- ìƒíƒœ í‘œì‹œ -->
                <div class="mb-4">
                    <span id="status-badge" class="badge fs-6
                        {% if execution.status == 'running' %}bg-primary
                        {% elif execution.status == 'completed' %}bg-success
                        {% elif execution.status == 'failed' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ execution.get_status_display }}
                    </span>
                </div>

                <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                <div class="progress mb-3" style="height: 30px;">
                    <div id="progress-bar"
                         class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: {{ execution.progress_percent }}%"
                         aria-valuenow="{{ execution.progress_percent }}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        <span id="progress-text">{{ execution.progress_percent }}%</span>
                    </div>
                </div>

                <!-- ì§„í–‰ ë©”ì‹œì§€ -->
                <p id="progress-message" class="text-muted mb-4">
                    {{ execution.progress_message|default:"ì²˜ë¦¬ ì¤‘..." }}
                </p>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div id="error-container" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="error-message"></span>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="mt-4">
                    <a href="{% url 'pipeline:project_data' project.pk %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> ëŒì•„ê°€ê¸°
                    </a>
                    <button id="cancel-btn" class="btn btn-danger ms-2" onclick="cancelExecution()">
                        <i class="bi bi-x-circle"></i> ì¤‘ì§€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-terminal"></i> ì‹¤í–‰ ë¡œê·¸</h5>
            </div>
            <div class="card-body p-0">
                <div id="log-container" class="log-container">
                    <div class="text-muted text-center py-4">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class ProgressPoller {
    constructor(executionId, projectPk) {
        this.executionId = executionId;
        this.projectPk = projectPk;
        this.interval = 1500;  // 1.5ì´ˆ
        this.timer = null;
        this.isPolling = false;
        this.lastLogCount = 0;
    }

    start() {
        if (this.isPolling) return;
        this.isPolling = true;
        this.poll();
    }

    stop() {
        this.isPolling = false;
        if (this.timer) {
            clearTimeout(this.timer);
            this.timer = null;
        }
    }

    async poll() {
        if (!this.isPolling) return;

        try {
            const response = await fetch(`/pipeline/project/${this.projectPk}/progress/${this.executionId}/api/`);
            const data = await response.json();

            this.updateUI(data);
            this.updateLogs(data.logs || []);

            if (data.status === 'completed' || data.status === 'failed') {
                this.stop();
                if (data.status === 'completed') {
                    setTimeout(() => {
                        window.location.href = `/pipeline/project/${this.projectPk}/data/`;
                    }, 2000);
                }
            } else {
                this.timer = setTimeout(() => this.poll(), this.interval);
            }
        } catch (error) {
            console.error('Polling error:', error);
            this.timer = setTimeout(() => this.poll(), this.interval * 2);
        }
    }

    updateUI(data) {
        // í”„ë¡œê·¸ë ˆìŠ¤ ë°”
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressBar.style.width = data.progress_percent + '%';
        progressBar.setAttribute('aria-valuenow', data.progress_percent);
        progressText.textContent = data.progress_percent + '%';

        // ìƒíƒœ ë°°ì§€
        const statusBadge = document.getElementById('status-badge');
        const statusClasses = {
            'pending': 'bg-secondary',
            'running': 'bg-primary',
            'completed': 'bg-success',
            'failed': 'bg-danger'
        };
        statusBadge.className = 'badge fs-6 ' + (statusClasses[data.status] || 'bg-secondary');

        const statusText = {
            'pending': 'ëŒ€ê¸°',
            'running': 'ì‹¤í–‰ ì¤‘',
            'completed': 'ì™„ë£Œ',
            'failed': 'ì‹¤íŒ¨'
        };
        statusBadge.textContent = statusText[data.status] || data.status;

        // ì§„í–‰ ë©”ì‹œì§€
        document.getElementById('progress-message').textContent =
            data.progress_message || 'ì²˜ë¦¬ ì¤‘...';

        // ì—ëŸ¬ ë©”ì‹œì§€
        if (data.error_message) {
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = data.error_message;
        }

        // í† í° ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸
        document.getElementById('input-tokens').textContent = this.formatNumber(data.input_tokens || 0);
        document.getElementById('output-tokens').textContent = this.formatNumber(data.output_tokens || 0);
        document.getElementById('total-tokens').textContent = this.formatNumber(data.total_tokens || 0);
        document.getElementById('cost-value').textContent = (data.estimated_cost || 0).toFixed(6);

        // ì™„ë£Œ ì‹œ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒ‰ìƒ ë³€ê²½
        if (data.status === 'completed') {
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            progressBar.classList.add('bg-success');
            document.getElementById('cancel-btn').style.display = 'none';
        } else if (data.status === 'failed' || data.status === 'cancelled') {
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            progressBar.classList.add('bg-danger');
            document.getElementById('cancel-btn').style.display = 'none';
        }
    }

    formatNumber(num) {
        return num.toLocaleString('ko-KR');
    }

    updateLogs(logs) {
        if (logs.length === this.lastLogCount) return;
        this.lastLogCount = logs.length;

        const container = document.getElementById('log-container');

        if (logs.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-4">ì•„ì§ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        for (const log of logs) {
            html += `<div class="log-entry">`;
            html += `<span class="log-time">[${log.time}]</span>`;
            html += `<span class="log-type-${log.type}">${this.getTypeIcon(log.type)} ${log.message}</span>`;

            if (log.data) {
                html += `<div class="log-data">`;
                if (log.data.queries && log.data.queries.length > 0) {
                    html += `ê²€ìƒ‰ì–´: ${log.data.queries.join(', ')}<br>`;
                }
                if (log.data.sources_count !== undefined) {
                    html += `ì¶œì²˜: ${log.data.sources_count}ê°œ<br>`;
                }
                if (log.data.text_preview) {
                    html += `<span class="log-source">"${log.data.text_preview}..."</span>`;
                }
                html += `</div>`;
            }
            html += `</div>`;
        }

        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    getTypeIcon(type) {
        const icons = {
            'info': 'â„¹ï¸',
            'search': 'ğŸ”',
            'result': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸'
        };
        return icons[type] || 'â€¢';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë§ ì‹œì‘
document.addEventListener('DOMContentLoaded', function() {
    const poller = new ProgressPoller({{ execution.pk }}, {{ project.pk }});
    poller.start();
});

// ì‹¤í–‰ ì·¨ì†Œ
async function cancelExecution() {
    if (!confirm('ì •ë§ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const btn = document.getElementById('cancel-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass"></i> ì¤‘ì§€ ì¤‘...';

    try {
        const response = await fetch(`/pipeline/project/{{ project.pk }}/progress/{{ execution.pk }}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();

        if (data.success) {
            alert('ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = `/pipeline/project/{{ project.pk }}/data/`;
        } else {
            alert(data.message || 'ì¤‘ì§€ ì‹¤íŒ¨');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-circle"></i> ì¤‘ì§€';
        }
    } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-x-circle"></i> ì¤‘ì§€';
    }
}
</script>
{% endblock %}
