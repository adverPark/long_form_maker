{% extends 'base.html' %}

{% block title %}설정 - 롱폼 영상 제작{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-gear"></i> 설정</h2>

<div class="row">
    <!-- API 키 관리 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key"></i> API 키 관리</h5>
            </div>
            <div class="card-body">
                <!-- Gemini 키 선택 -->
                <h6><i class="bi bi-stars"></i> Gemini 키 선택</h6>
                <form method="post" action="{% url 'accounts:save_api_key' %}" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="service" value="gemini">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <input type="text" name="name" class="form-control" placeholder="이름 (예: 개인용)" required>
                        </div>
                        <div class="col-md-5">
                            <input type="password" name="api_key" class="form-control" placeholder="API 키 입력" required>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input type="checkbox" name="is_default" class="form-check-input" id="gemini_default">
                                <label class="form-check-label" for="gemini_default">기본</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-lg"></i> 추가
                            </button>
                        </div>
                    </div>
                </form>
                {% if gemini_keys %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>키</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in gemini_keys %}
                        <tr>
                            <td>{{ key.name }}</td>
                            <td><code>{{ key.get_masked_key }}</code></td>
                            <td>
                                {% if key.is_default %}
                                <span class="badge bg-primary">기본</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not key.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_api_key' key.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary">기본 설정</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_api_key' key.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">등록된 Gemini 키가 없습니다.</p>
                {% endif %}

                <!-- Replicate 키 선택 -->
                <h6 class="mt-4"><i class="bi bi-film"></i> Replicate 키 선택</h6>
                <form method="post" action="{% url 'accounts:save_api_key' %}" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="service" value="replicate">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <input type="text" name="name" class="form-control" placeholder="이름 (예: 개인용)" required>
                        </div>
                        <div class="col-md-5">
                            <input type="password" name="api_key" class="form-control" placeholder="API 키 입력" required>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input type="checkbox" name="is_default" class="form-check-input" id="replicate_default">
                                <label class="form-check-label" for="replicate_default">기본</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-lg"></i> 추가
                            </button>
                        </div>
                    </div>
                </form>
                {% if replicate_keys %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>키</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in replicate_keys %}
                        <tr>
                            <td>{{ key.name }}</td>
                            <td><code>{{ key.get_masked_key }}</code></td>
                            <td>
                                {% if key.is_default %}
                                <span class="badge bg-primary">기본</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not key.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_api_key' key.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary">기본 설정</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_api_key' key.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">등록된 Replicate 키가 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 프리셋 관리 -->
<h3 class="mt-5 mb-4"><i class="bi bi-palette"></i> 프리셋 관리</h3>

<div class="row">
    <!-- 이미지 스타일 프리셋 -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-brush"></i> 이미지 스타일</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'accounts:save_image_style' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">스타일 이름</label>
                        <input type="text" name="name" class="form-control" placeholder="예: 뉴스 다큐멘터리" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">스타일 프롬프트</label>
                        <textarea name="style_prompt" class="form-control" rows="3"
                                  placeholder="예: Photorealistic news documentary style, professional lighting..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">샘플 이미지 (선택)</label>
                        <input type="file" name="sample_images" class="form-control" accept="image/*" multiple>
                        <small class="text-muted">최대 3개까지 업로드 가능</small>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_default" class="form-check-input" id="style_default">
                        <label class="form-check-label" for="style_default">기본 스타일로 설정</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-lg"></i> 추가
                    </button>
                </form>

                <hr>

                {% if image_styles %}
                <ul class="list-group">
                    {% for style in image_styles %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start" style="cursor: pointer;"
                                 onclick="editImageStyle({{ style.pk }}, '{{ style.name|escapejs }}', '{{ style.style_prompt|escapejs }}')">
                                {% if style.sample_images.count > 0 %}
                                <div class="me-2 d-flex gap-1">
                                    {% for sample in style.sample_images.all|slice:":3" %}
                                    <img src="{{ sample.image.url }}" alt=""
                                         class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div>
                                    <strong>{{ style.name }}</strong>
                                    {% if style.is_default %}
                                    <span class="badge bg-primary ms-2">기본</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ style.style_prompt|truncatechars:40 }}</small>
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm">
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-1"
                                        onclick="editImageStyle({{ style.pk }}, '{{ style.name|escapejs }}', '{{ style.style_prompt|escapejs }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if not style.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_image_style' style.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 mb-1">기본</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_image_style' style.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">등록된 스타일이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 캐릭터 프리셋 -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-circle"></i> 캐릭터</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'accounts:save_character' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">캐릭터 이름</label>
                        <input type="text" name="name" class="form-control" placeholder="예: 경제 해설자" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">캐릭터 이미지</label>
                        <input type="file" name="image" class="form-control" accept="image/*" required>
                        <small class="text-muted">캐릭터 시트 또는 참조 이미지</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">캐릭터 프롬프트</label>
                        <textarea name="character_prompt" class="form-control" rows="3"
                                  placeholder="예: Young Korean male anchor in suit, friendly expression..." required></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_default" class="form-check-input" id="char_default">
                        <label class="form-check-label" for="char_default">기본 캐릭터로 설정</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-lg"></i> 추가
                    </button>
                </form>

                <hr>

                {% if characters %}
                <ul class="list-group">
                    {% for char in characters %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-start" style="cursor: pointer;"
                                 onclick="editCharacter({{ char.pk }}, '{{ char.name|escapejs }}', '{{ char.character_prompt|escapejs }}')">
                                {% if char.image %}
                                <img src="{{ char.image.url }}" alt="{{ char.name }}"
                                     class="rounded me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                {% endif %}
                                <div>
                                    <strong>{{ char.name }}</strong>
                                    {% if char.is_default %}
                                    <span class="badge bg-primary ms-2">기본</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ char.character_prompt|truncatechars:40 }}</small>
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm">
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-1"
                                        onclick="editCharacter({{ char.pk }}, '{{ char.name|escapejs }}', '{{ char.character_prompt|escapejs }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if not char.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_character' char.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 mb-1">기본</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_character' char.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">등록된 캐릭터가 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- TTS 음성 프리셋 -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-soundwave"></i> TTS 음성</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'accounts:save_voice_preset' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">음성 이름</label>
                        <input type="text" name="name" class="form-control" placeholder="예: 차분한 남성 목소리" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">참조 음성 파일</label>
                        <input type="file" name="reference_audio" class="form-control" accept="audio/*" required>
                        <small class="text-muted">Fish Speech 참조용 WAV 파일</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">참조 음성 텍스트</label>
                        <textarea name="reference_text" class="form-control" rows="2"
                                  placeholder="참조 음성에서 말한 내용을 정확히 입력" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Temperature</label>
                            <input type="number" name="temperature" class="form-control"
                                   value="0.7" step="0.1" min="0" max="1">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Top P</label>
                            <input type="number" name="top_p" class="form-control"
                                   value="0.7" step="0.1" min="0" max="1">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Seed</label>
                            <input type="number" name="seed" class="form-control" value="42">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_default" class="form-check-input" id="voice_preset_default">
                        <label class="form-check-label" for="voice_preset_default">기본 음성으로 설정</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-lg"></i> 추가
                    </button>
                </form>

                <hr>

                {% if voices %}
                <ul class="list-group">
                    {% for voice in voices %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="cursor: pointer;"
                                 onclick="editVoice({{ voice.pk }}, '{{ voice.name|escapejs }}', '{{ voice.reference_text|escapejs }}', {{ voice.temperature }}, {{ voice.top_p }}, {{ voice.seed }}, '{{ voice.reference_audio.url }}')">
                                <strong>{{ voice.name }}</strong>
                                {% if voice.is_default %}
                                <span class="badge bg-primary ms-2">기본</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">
                                    T={{ voice.temperature }} | P={{ voice.top_p }} | Seed={{ voice.seed }}
                                </small>
                                <br>
                                <small class="text-info">{{ voice.reference_text|truncatechars:30 }}</small>
                            </div>
                            <div class="btn-group-vertical btn-group-sm">
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-1"
                                        onclick="editVoice({{ voice.pk }}, '{{ voice.name|escapejs }}', '{{ voice.reference_text|escapejs }}', {{ voice.temperature }}, {{ voice.top_p }}, {{ voice.seed }}, '{{ voice.reference_audio.url }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if not voice.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_voice_preset' voice.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 mb-1">기본</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_voice_preset' voice.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">등록된 TTS 음성이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 썸네일 스타일 프리셋 -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-card-image"></i> 썸네일 스타일</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'accounts:add_thumbnail_style' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">스타일 이름</label>
                        <input type="text" name="name" class="form-control" placeholder="예: 유튜브 경제 채널" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">스타일 타입</label>
                        <select name="style_type" class="form-select">
                            <option value="youtube">YouTube (눈에 띄는)</option>
                            <option value="minimalist">미니멀 (깔끔한)</option>
                            <option value="bold">볼드 (강렬한)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">예시 이미지</label>
                        <input type="file" name="example_image" class="form-control" accept="image/*">
                        <small class="text-muted">참고할 썸네일 예시</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">프롬프트 템플릿</label>
                        <textarea name="prompt_template" class="form-control" rows="4"
                                  placeholder="사용 가능한 변수: {title}, {hook}, {main_keyword}, {style_type}"></textarea>
                        <small class="text-muted">비워두면 기본 템플릿 사용</small>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" name="is_default" class="form-check-input" id="thumbnail_style_default">
                        <label class="form-check-label" for="thumbnail_style_default">기본 스타일로 설정</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-lg"></i> 추가
                    </button>
                </form>

                <hr>

                {% if thumbnail_styles %}
                <ul class="list-group">
                    {% for style in thumbnail_styles %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-center"
                                 onclick="editThumbnailStyle({{ style.pk }}, '{{ style.name|escapejs }}', '{{ style.style_type }}', '{{ style.prompt_template|escapejs }}')"
                                 style="cursor: pointer; flex: 1;">
                                {% if style.example_image %}
                                <img src="{{ style.example_image.url }}" class="me-2" style="width: 50px; height: 30px; object-fit: cover; border-radius: 4px;">
                                {% else %}
                                <div class="me-2 bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 30px; border-radius: 4px;">
                                    <i class="bi bi-card-image text-muted"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <strong>{{ style.name }}</strong>
                                    <span class="badge bg-secondary">{{ style.get_style_type_display }}</span>
                                    {% if style.is_default %}
                                    <span class="badge bg-primary">기본</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm">
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-1"
                                        onclick="editThumbnailStyle({{ style.pk }}, '{{ style.name|escapejs }}', '{{ style.style_type }}', '{{ style.prompt_template|escapejs }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if not style.is_default %}
                                <form method="post" action="{% url 'accounts:set_default_thumbnail_style' style.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary w-100 mb-1">기본</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'accounts:delete_thumbnail_style' style.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100"
                                            onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">등록된 썸네일 스타일이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 이미지 스타일 수정 모달 -->
<div class="modal fade" id="editStyleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-brush"></i> 이미지 스타일 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editStyleId">
                <div class="mb-3">
                    <label class="form-label">스타일 이름</label>
                    <input type="text" id="editStyleName" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">스타일 프롬프트</label>
                    <textarea id="editStylePrompt" class="form-control" rows="4"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">샘플 이미지 교체 (선택)</label>
                    <input type="file" id="editStyleImages" class="form-control" accept="image/*" multiple>
                    <small class="text-warning">업로드 시 기존 샘플 이미지가 모두 교체됩니다</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveImageStyle()">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 캐릭터 수정 모달 -->
<div class="modal fade" id="editCharacterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-circle"></i> 캐릭터 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCharId">
                <div class="mb-3">
                    <label class="form-label">캐릭터 이름</label>
                    <input type="text" id="editCharName" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">캐릭터 프롬프트</label>
                    <textarea id="editCharPrompt" class="form-control" rows="4"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">새 이미지 (선택)</label>
                    <input type="file" id="editCharImage" class="form-control" accept="image/*">
                    <small class="text-muted">업로드 시 기존 이미지 대체</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveCharacter()">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- TTS 음성 수정 모달 -->
<div class="modal fade" id="editVoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-soundwave"></i> TTS 음성 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editVoiceId">
                <div class="mb-3">
                    <label class="form-label">음성 이름</label>
                    <input type="text" id="editVoiceName" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">참조 음성 텍스트</label>
                    <textarea id="editVoiceText" class="form-control" rows="2"></textarea>
                </div>
                <div class="row mb-3">
                    <div class="col-4">
                        <label class="form-label">Temperature</label>
                        <input type="number" id="editVoiceTemp" class="form-control" step="0.1" min="0" max="1">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Top P</label>
                        <input type="number" id="editVoiceTopP" class="form-control" step="0.1" min="0" max="1">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Seed</label>
                        <input type="number" id="editVoiceSeed" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">현재 참조 음성</label>
                    <div id="editVoiceCurrentAudio"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">새 참조 음성 (선택)</label>
                    <input type="file" id="editVoiceAudio" class="form-control" accept="audio/*">
                    <small class="text-muted">업로드 시 기존 음성 대체</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveVoice()">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 썸네일 스타일 수정 모달 -->
<div class="modal fade" id="editThumbnailStyleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-card-image"></i> 썸네일 스타일 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editThumbnailStyleId">
                <div class="mb-3">
                    <label class="form-label">스타일 이름</label>
                    <input type="text" id="editThumbnailStyleName" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">스타일 타입</label>
                    <select id="editThumbnailStyleType" class="form-select">
                        <option value="youtube">YouTube (눈에 띄는)</option>
                        <option value="minimalist">미니멀 (깔끔한)</option>
                        <option value="bold">볼드 (강렬한)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">프롬프트 템플릿</label>
                    <textarea id="editThumbnailStylePrompt" class="form-control" rows="6"
                              placeholder="사용 가능한 변수: {title}, {hook}, {main_keyword}, {style_type}"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">새 예시 이미지 (선택)</label>
                    <input type="file" id="editThumbnailStyleImage" class="form-control" accept="image/*">
                    <small class="text-muted">업로드 시 기존 이미지 대체</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveThumbnailStyle()">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF 토큰
const csrfToken = '{{ csrf_token }}';

// 이미지 스타일 수정
function editImageStyle(pk, name, stylePrompt) {
    document.getElementById('editStyleId').value = pk;
    document.getElementById('editStyleName').value = name;
    document.getElementById('editStylePrompt').value = stylePrompt;
    document.getElementById('editStyleImages').value = '';
    new bootstrap.Modal(document.getElementById('editStyleModal')).show();
}

function saveImageStyle() {
    const pk = document.getElementById('editStyleId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editStyleName').value);
    formData.append('style_prompt', document.getElementById('editStylePrompt').value);

    const files = document.getElementById('editStyleImages').files;
    for (let i = 0; i < files.length; i++) {
        formData.append('sample_images', files[i]);
    }

    fetch(`/accounts/image-style/edit/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '저장 실패');
        }
    })
    .catch(() => alert('저장 중 오류 발생'));
}

// 캐릭터 수정
function editCharacter(pk, name, characterPrompt) {
    document.getElementById('editCharId').value = pk;
    document.getElementById('editCharName').value = name;
    document.getElementById('editCharPrompt').value = characterPrompt;
    document.getElementById('editCharImage').value = '';
    new bootstrap.Modal(document.getElementById('editCharacterModal')).show();
}

function saveCharacter() {
    const pk = document.getElementById('editCharId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editCharName').value);
    formData.append('character_prompt', document.getElementById('editCharPrompt').value);

    const file = document.getElementById('editCharImage').files[0];
    if (file) {
        formData.append('image', file);
    }

    fetch(`/accounts/character/edit/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '저장 실패');
        }
    })
    .catch(() => alert('저장 중 오류 발생'));
}

// TTS 음성 수정
function editVoice(pk, name, referenceText, temperature, topP, seed, audioUrl) {
    document.getElementById('editVoiceId').value = pk;
    document.getElementById('editVoiceName').value = name;
    document.getElementById('editVoiceText').value = referenceText;
    document.getElementById('editVoiceTemp').value = temperature;
    document.getElementById('editVoiceTopP').value = topP;
    document.getElementById('editVoiceSeed').value = seed;
    document.getElementById('editVoiceAudio').value = '';

    // 현재 음성 파일 표시
    const audioContainer = document.getElementById('editVoiceCurrentAudio');
    if (audioUrl) {
        audioContainer.innerHTML = `
            <audio controls class="w-100" style="height: 40px;">
                <source src="${audioUrl}" type="audio/wav">
            </audio>
            <small class="text-muted">${audioUrl.split('/').pop()}</small>
        `;
    } else {
        audioContainer.innerHTML = '<small class="text-muted">음성 파일 없음</small>';
    }

    new bootstrap.Modal(document.getElementById('editVoiceModal')).show();
}

function saveVoice() {
    const pk = document.getElementById('editVoiceId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editVoiceName').value);
    formData.append('reference_text', document.getElementById('editVoiceText').value);
    formData.append('temperature', document.getElementById('editVoiceTemp').value);
    formData.append('top_p', document.getElementById('editVoiceTopP').value);
    formData.append('seed', document.getElementById('editVoiceSeed').value);

    const file = document.getElementById('editVoiceAudio').files[0];
    if (file) {
        formData.append('reference_audio', file);
    }

    fetch(`/accounts/voice-preset/edit/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '저장 실패');
        }
    })
    .catch(() => alert('저장 중 오류 발생'));
}

// 썸네일 스타일 수정
function editThumbnailStyle(pk, name, styleType, promptTemplate) {
    document.getElementById('editThumbnailStyleId').value = pk;
    document.getElementById('editThumbnailStyleName').value = name;
    document.getElementById('editThumbnailStyleType').value = styleType;
    document.getElementById('editThumbnailStylePrompt').value = promptTemplate;
    document.getElementById('editThumbnailStyleImage').value = '';
    new bootstrap.Modal(document.getElementById('editThumbnailStyleModal')).show();
}

function saveThumbnailStyle() {
    const pk = document.getElementById('editThumbnailStyleId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editThumbnailStyleName').value);
    formData.append('style_type', document.getElementById('editThumbnailStyleType').value);
    formData.append('prompt_template', document.getElementById('editThumbnailStylePrompt').value);

    const file = document.getElementById('editThumbnailStyleImage').files[0];
    if (file) {
        formData.append('example_image', file);
    }

    fetch(`/accounts/thumbnail-style/edit/${pk}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '저장 실패');
        }
    })
    .catch(() => alert('저장 중 오류 발생'));
}
</script>
{% endblock %}
